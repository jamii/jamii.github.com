<!DOCTYPE html><html lang="en"><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>Smarkets API documentation</title><meta name="author" content="Jamie Brandon" /><link rel="alternate" type="application/rss+xml" title="Scattered Thoughts - " href="/feed.xml" /><style> @import url("https://fonts.googleapis.com/css?family=Fira+Code:400,700|Fira+Sans:400,400i,700,700i&display=swap");progress,sub,sup{vertical-align:baseline}button,hr,input{overflow:visible}html{font-family:sans-serif;line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}figcaption,menu,article,aside,details,figure,footer,header,main,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,select{text-transform:none}[type=submit],[type=reset],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:ButtonText dotted 1px}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}code{background:#ffffff}.highlight{background:#ffffff}.highlight pre{background-color:#fff;font-size:16px}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#fdd}.highlight .gd .x{color:#000000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000000;background-color:#dfd}.highlight .gi .x{color:#000000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}.highlight .lineno{color:rgba(0,0,0,0.3);padding:0 10px;-webkit-user-select:none;-moz-user-select:none;-o-user-select:none}.lineno::-moz-selection{background-color:transparent}.lineno::selection{background-color:transparent}body{padding:32px;color:#333333;background-color:#ffffff;font-family:Fira Sans, serif}.container{max-width:45em;margin:0 auto;font-size:20px}body blockquote{border-left:2px solid #333333 !important}article{font-size:1em}h1,h2,h3{font-weight:800;font-family:Fira Sans, sans-serif}h1{text-align:center;font-size:2.0em}h2{text-align:center;font-size:1.2em;margin-top:4em}h3{text-align:center;font-size:1em}h4{text-align:center}a{text-decoration:underline;font-weight:normal}a,a:visited,a:hover,a:active{color:#0085a1}*{max-width:100%}pre,figure,.wp-caption{margin:0px -10px 20px -10px;padding:0px 10px 0px 10px}blockquote{margin:0;padding:0px 10px 0px 10px;border-radius:5px}p>img:only-child,p>a:only-child>img:only-child,.wp-caption img,figure img{display:block}img{margin-left:auto;margin-right:auto}.caption,.wp-caption-text,figcaption{font-size:0.9em;line-height:1.48em;font-style:italic}code,pre{white-space:pre;overflow:visible;font-family:Fira Code, monospace}ul,ol{padding:0}ul{padding-left:30px;list-style:disc}ol{padding-left:30px;list-style:decimal}.post-link{padding-bottom:10px;text-align:center}.post-link a{text-decoration:none;color:#333333}.post-link a:focus,.post-link a:hover{color:#0085a1}.post-link .post-title{margin:0;font-size:18px}nav{text-align:center}nav a{font-size:1.4em}nav a,nav a:visited{text-decoration:none;color:#333333}nav a:focus,nav a:hover{color:#0085a1}.menu ul{list-style:none;padding:0;margin:0}header{margin:2em 0 2em 0;text-align:center}header h1{margin:0}footer{margin-top:4em;text-align:center;font-style:italic}iframe{width:560px;height:315px;display:block;margin:0 auto;padding-top:1em}table{margin-left:auto;margin-right:auto;border-collapse:collapse}table,th,td{padding:0.5em;border:0.5px solid #333333}hr{width:7em;margin-top:3em;margin-bottom:3em;border:0;height:1px;background-image:linear-gradient(to right, transparent, rgba(0,0,0,0.75), transparent)}</style><nav> <a href="/"> JAMIE BRANDON </a></nav><div class="container"><header><h1>Smarkets API documentation</h1></header><article role="main"><p>I want to write a little about the documentation system I wrote for the smarkets API. The main concern I had with the documentation was that it would be incorrect or become out of sync with the code, especially since I didn’t really understand the system when I started documenting it. To prevent this I built a couple of documentation tools that have paid for themselves many times over.<p>We have our own home-grown and slightly crappy web framework which powers the public API. A typical resource declaration looks like this:<div class="language-erlang highlighter-rouge"><pre class="highlight"><code>   <span class="nl">#a</span><span class="p">{</span><span class="n">m</span><span class="o">=</span><span class="p">[</span><span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">user_id</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">emails</span><span class="p">,</span>
         <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">email</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="nb">hash</span><span class="o">/</span><span class="mi">1</span><span class="p">],</span>
      <span class="n">f</span><span class="o">=</span><span class="p">[{</span><span class="n">'PUT'</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_users</span><span class="p">:</span><span class="n">user_or_admin</span><span class="o">/</span><span class="mi">3</span><span class="p">}],</span>
      <span class="n">scope</span><span class="o">=</span><span class="p">[{</span><span class="n">'PUT'</span><span class="p">,</span> <span class="n">private</span><span class="p">}],</span>
      <span class="n">pu</span><span class="o">=</span><span class="k">fun</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">,</span> <span class="p">_</span><span class="nv">Auth</span><span class="p">,</span> <span class="nv">Ctx</span><span class="p">)</span> <span class="o">-&gt;</span>
             <span class="k">case</span> <span class="nn">users</span><span class="p">:</span><span class="nf">verify_email</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">)</span> <span class="k">of</span>
               <span class="n">ok</span> <span class="o">-&gt;</span>
                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="nf">nc</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">conflict</span><span class="p">}</span> <span class="o">-&gt;</span>
                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="nf">cfl</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">not_found</span><span class="p">}</span> <span class="o">-&gt;</span>
                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="nf">nf</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">)</span>
             <span class="k">end</span>
         <span class="k">end</span><span class="p">}</span>
</code></pre></div><p>To this I added a documentation field for each method:<div class="language-erlang highlighter-rouge"><pre class="highlight"><code>   <span class="nl">#a</span><span class="p">{</span><span class="n">m</span><span class="o">=</span><span class="p">[</span><span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">user_id</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">emails</span><span class="p">,</span>
         <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">email</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="nb">hash</span><span class="o">/</span><span class="mi">1</span><span class="p">],</span>
      <span class="n">f</span><span class="o">=</span><span class="p">[{</span><span class="n">'PUT'</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_users</span><span class="p">:</span><span class="n">user_or_admin</span><span class="o">/</span><span class="mi">3</span><span class="p">}],</span>
      <span class="n">scope</span><span class="o">=</span><span class="p">[{</span><span class="n">'PUT'</span><span class="p">,</span> <span class="n">private</span><span class="p">}],</span>
      <span class="n">pu_doc</span> <span class="o">=</span> <span class="nl">#'doc.method'</span><span class="p">{</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">"Verify the specified email using the hash code sent to the user"</span><span class="p">,</span>
        <span class="n">responses</span> <span class="o">=</span>
          <span class="p">[{</span><span class="mi">200</span><span class="p">,</span> <span class="s">"Successful"</span><span class="p">}</span>
          <span class="p">,{</span><span class="mi">404</span><span class="p">,</span> <span class="s">"Specified user or email does not exist"</span><span class="p">}</span>
          <span class="p">,{</span><span class="mi">409</span><span class="p">,</span> <span class="s">"Incorrect hash code"</span><span class="p">}]},</span>
      <span class="n">pu</span><span class="o">=</span><span class="k">fun</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">,</span> <span class="p">_</span><span class="nv">Auth</span><span class="p">,</span> <span class="nv">Ctx</span><span class="p">)</span> <span class="o">-&gt;</span>
             <span class="k">case</span> <span class="nn">users</span><span class="p">:</span><span class="nf">verify_email</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">)</span> <span class="k">of</span>
               <span class="n">ok</span> <span class="o">-&gt;</span>
                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="nf">nc</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">conflict</span><span class="p">}</span> <span class="o">-&gt;</span>
                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="nf">cfl</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">not_found</span><span class="p">}</span> <span class="o">-&gt;</span>
                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="nf">nf</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">)</span>
             <span class="k">end</span>
         <span class="k">end</span><span class="p">}</span>
</code></pre></div><p>From this the documentation system generates a json object which is stored in couchdb:<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users/{user_id}/emails/{email}/{hash}"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"_rev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1-0c4c3aad1227a62429ffb0c05a7059f1"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"doc.action"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nt">"methods"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
           </span><span class="nt">"PUT"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
               </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"doc.method"</span><span class="p">,</span><span class="w">
               </span><span class="nt">"term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                   </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                   </span><span class="p">},</span><span class="w">
                   </span><span class="nt">"opt_params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                   </span><span class="p">},</span><span class="w">
                   </span><span class="nt">"req_params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                   </span><span class="p">},</span><span class="w">
                   </span><span class="nt">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"private"</span><span class="p">,</span><span class="w">
                   </span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rest_users.user_or_admin"</span><span class="p">,</span><span class="w">
                   </span><span class="nt">"auth"</span><span class="p">:</span><span class="w"> </span><span class="s2">"needs_user"</span><span class="p">,</span><span class="w">
                   </span><span class="nt">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                       </span><span class="nt">"200"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Successful"</span><span class="p">,</span><span class="w">
                       </span><span class="nt">"404"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Specified user or email does not exist"</span><span class="p">,</span><span class="w">
                       </span><span class="nt">"409"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Incorrect hash code"</span><span class="w">
                   </span><span class="p">},</span><span class="w">
                   </span><span class="nt">"doc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Verify the specified email using the hash code sent to the user"</span><span class="w">
               </span><span class="p">}</span><span class="w">
           </span><span class="p">}</span><span class="w">
       </span><span class="p">},</span><span class="w">
       </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users/{user_id}/emails/{email}/{hash}"</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><p>This json object is used by a couple of different scripts. Both the <a href="http://smarkets.com/api/documentation/">public api reference</a> and our own internal api reference are produced from these json objects. I also added a fuzzer which can read the json documentation and generate calls with both random data and records pulled from the development database. The fuzzer logs the results of these calls like this:<div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nt">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"320f2a4bc956334c66c84a4d9f6160a0"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"_rev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1-a109f7aa2906e2452e45a49d649674cb"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span><span class="p">,</span><span class="w">
   </span><span class="nt">"path_spec"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users/{user_id}/emails/{email}/{hash}"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PUT"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nt">"Content-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w">
       </span><span class="nt">"Authorization"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UserLogin token=\"O3bHthtJ6wumlt0yjf0q8OrYURMBKiRbfNRmhfGLJNCXhcXkSrzyPVzm47MoWD_lt6UdOJlA8wf1AWY~\""</span><span class="w">
   </span><span class="p">},</span><span class="w">
   </span><span class="nt">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"users/54ad2cc2a1dd2871518c528a11a40f00/emails/jMt%40XPqKYLNx/50584d82c756b2e4a53c8695553ae34a"</span><span class="p">,</span><span class="w">
   </span><span class="nt">"response"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
   </span><span class="nt">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">9000</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Another set of scripts then combs through these tables looking for errors. Anything that returns ‘500 internal server error’ is flagged. Calls which return ‘400 bad request’ and are not tagged as being deliberately malformed are also flagged. Same goes for any response code which isn’t documented for that call and any documented response code which isn’t observed in the fuzzer table. One particularly useful script lists methods which are accessible via the public port.<p>This system has worked out quite well so far. The documentation is embedded directly next to the related code so its hard to forget to update it when changing the code. The fuzzer is worth its weight in gold and has uncovered countless bugs and weird corner cases. For such a crude fuzzer it generates suprisingly good code coverage. The next step is to combine the fuzzer with a smallcheck-style test system in order to better narrow down errors in long sequences of calls.</article><footer><div>Questions? Comments? Just want to chat?</div><div><a href="mailto:jamie@scattered-thoughts.net>jamie@scattered-thoughts.net">jamie@scattered-thoughts.net</a></div><br><p><a href="/feed.xml"><img src="/img/rss.png"></img></a></footer></div>
