
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Smarkets API documentation - Scattered Thoughts</title>
	<meta name="author" content="Jamie Brandon">

	
	<meta name="description" content="I want to write a little about the documentation system I wrote for the smarkets API. The main concern I had with the documentation was that it would &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Scattered Thoughts</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:scattered-thoughts.net">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="email" href="mailto:jamie@scattered-thoughts.net" title="Email">Email</a>
		
		
		
		
		
		<a class="github" href="https://github.com/jamii" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:scattered-thoughts.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Smarkets API documentation</h1>
	<div class="entry-content"><p>I want to write a little about the documentation system I wrote for the smarkets API. The main concern I had with the documentation was that it would be incorrect or become out of sync with the code, especially since I didn&#8217;t really understand the system when I started documenting it. To prevent this I built a couple of documentation tools that have paid for themselves many times over.</p>

<!--more-->


<p>We have our own home-grown and slightly crappy web framework which powers the public API. A typical resource declaration looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>   <span class="nl">#a</span><span class="p">{</span><span class="n">m</span><span class="o">=</span><span class="p">[</span><span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">user_id</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">emails</span><span class="p">,</span>
</span><span class='line'>         <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">email</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="nb">hash</span><span class="o">/</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>      <span class="n">f</span><span class="o">=</span><span class="p">[{</span><span class="n">&#39;PUT&#39;</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_users</span><span class="p">:</span><span class="n">user_or_admin</span><span class="o">/</span><span class="mi">3</span><span class="p">}],</span>
</span><span class='line'>      <span class="n">scope</span><span class="o">=</span><span class="p">[{</span><span class="n">&#39;PUT&#39;</span><span class="p">,</span> <span class="n">private</span><span class="p">}],</span>
</span><span class='line'>      <span class="n">pu</span><span class="o">=</span><span class="k">fun</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">,</span> <span class="p">_</span><span class="nv">Auth</span><span class="p">,</span> <span class="nv">Ctx</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>             <span class="k">case</span> <span class="nn">users</span><span class="p">:</span><span class="n">verify_email</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>               <span class="n">ok</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="n">nc</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
</span><span class='line'>               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">conflict</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="n">cfl</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
</span><span class='line'>               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">not_found</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="n">nf</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">)</span>
</span><span class='line'>             <span class="k">end</span>
</span><span class='line'>         <span class="k">end</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To this I added a documentation field for each method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'>   <span class="nl">#a</span><span class="p">{</span><span class="n">m</span><span class="o">=</span><span class="p">[</span><span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">user_id</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">emails</span><span class="p">,</span>
</span><span class='line'>         <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="n">email</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_aux</span><span class="p">:</span><span class="nb">hash</span><span class="o">/</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>      <span class="n">f</span><span class="o">=</span><span class="p">[{</span><span class="n">&#39;PUT&#39;</span><span class="p">,</span> <span class="k">fun</span> <span class="nn">rest_users</span><span class="p">:</span><span class="n">user_or_admin</span><span class="o">/</span><span class="mi">3</span><span class="p">}],</span>
</span><span class='line'>      <span class="n">scope</span><span class="o">=</span><span class="p">[{</span><span class="n">&#39;PUT&#39;</span><span class="p">,</span> <span class="n">private</span><span class="p">}],</span>
</span><span class='line'>      <span class="n">pu_doc</span> <span class="o">=</span> <span class="nl">#&#39;doc.method&#39;</span><span class="p">{</span>
</span><span class='line'>        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Verify the specified email using the hash code sent to the user&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">responses</span> <span class="o">=</span>
</span><span class='line'>          <span class="p">[{</span><span class="mi">200</span><span class="p">,</span> <span class="s">&quot;Successful&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="p">,{</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;Specified user or email does not exist&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="p">,{</span><span class="mi">409</span><span class="p">,</span> <span class="s">&quot;Incorrect hash code&quot;</span><span class="p">}]},</span>
</span><span class='line'>      <span class="n">pu</span><span class="o">=</span><span class="k">fun</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">,</span> <span class="p">_</span><span class="nv">Auth</span><span class="p">,</span> <span class="nv">Ctx</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>             <span class="k">case</span> <span class="nn">users</span><span class="p">:</span><span class="n">verify_email</span><span class="p">(</span><span class="nv">UserId</span><span class="p">,</span> <span class="nv">Email</span><span class="p">,</span> <span class="nv">Hash</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>               <span class="n">ok</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="n">nc</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
</span><span class='line'>               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">conflict</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="n">cfl</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">);</span>
</span><span class='line'>               <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">not_found</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>                 <span class="nn">smarkets_rest</span><span class="p">:</span><span class="n">nf</span><span class="p">(</span><span class="nv">Ctx</span><span class="p">)</span>
</span><span class='line'>             <span class="k">end</span>
</span><span class='line'>         <span class="k">end</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>From this the documentation system generates a json object which is stored in couchdb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;users/{user_id}/emails/{email}/{hash}&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-0c4c3aad1227a62429ffb0c05a7059f1&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc.action&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;methods&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>           <span class="nt">&quot;PUT&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>               <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc.method&quot;</span><span class="p">,</span>
</span><span class='line'>               <span class="nt">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                   <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                   <span class="p">},</span>
</span><span class='line'>                   <span class="nt">&quot;opt_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                   <span class="p">},</span>
</span><span class='line'>                   <span class="nt">&quot;req_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                   <span class="p">},</span>
</span><span class='line'>                   <span class="nt">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;private&quot;</span><span class="p">,</span>
</span><span class='line'>                   <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;rest_users.user_or_admin&quot;</span><span class="p">,</span>
</span><span class='line'>                   <span class="nt">&quot;auth&quot;</span><span class="p">:</span> <span class="s2">&quot;needs_user&quot;</span><span class="p">,</span>
</span><span class='line'>                   <span class="nt">&quot;responses&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                       <span class="nt">&quot;200&quot;</span><span class="p">:</span> <span class="s2">&quot;Successful&quot;</span><span class="p">,</span>
</span><span class='line'>                       <span class="nt">&quot;404&quot;</span><span class="p">:</span> <span class="s2">&quot;Specified user or email does not exist&quot;</span><span class="p">,</span>
</span><span class='line'>                       <span class="nt">&quot;409&quot;</span><span class="p">:</span> <span class="s2">&quot;Incorrect hash code&quot;</span>
</span><span class='line'>                   <span class="p">},</span>
</span><span class='line'>                   <span class="nt">&quot;doc&quot;</span><span class="p">:</span> <span class="s2">&quot;Verify the specified email using the hash code sent to the user&quot;</span>
</span><span class='line'>               <span class="p">}</span>
</span><span class='line'>           <span class="p">}</span>
</span><span class='line'>       <span class="p">},</span>
</span><span class='line'>       <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;users/{user_id}/emails/{email}/{hash}&quot;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This json object is used by a couple of different scripts. Both the <a href="http://smarkets.com/api/documentation/">public api reference</a> and our own internal api reference are produced from these json objects. I also added a fuzzer which can read the json documentation and generate calls with both random data and records pulled from the development database. The fuzzer logs the results of these calls like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;320f2a4bc956334c66c84a4d9f6160a0&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-a109f7aa2906e2452e45a49d649674cb&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;{}&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;code&quot;</span><span class="p">:</span> <span class="mi">403</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;path_spec&quot;</span><span class="p">:</span> <span class="s2">&quot;users/{user_id}/emails/{email}/{hash}&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;Content-type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;UserLogin token=\&quot;O3bHthtJ6wumlt0yjf0q8OrYURMBKiRbfNRmhfGLJNCXhcXkSrzyPVzm47MoWD_lt6UdOJlA8wf1AWY~\&quot;&quot;</span>
</span><span class='line'>   <span class="p">},</span>
</span><span class='line'>   <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;users/54ad2cc2a1dd2871518c528a11a40f00/emails/jMt%40XPqKYLNx/50584d82c756b2e4a53c8695553ae34a&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;response&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">9000</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another set of scripts then combs through these tables looking for errors. Anything that returns &#8216;500 internal server error&#8217; is flagged. Calls which return &#8216;400 bad request&#8217; and are not tagged as being deliberately malformed are also flagged. Same goes for any response code which isn&#8217;t documented for that call and any documented response code which isn&#8217;t observed in the fuzzer table. One particularly useful script lists methods which are accessible via the public port.</p>

<p>This system has worked out quite well so far. The documentation is embedded directly next to the related code so its hard to forget to update it when changing the code. The fuzzer is worth its weight in gold and has uncovered countless bugs and weird corner cases. For such a crude fuzzer it generates suprisingly good code coverage. The next step is to combine the fuzzer with a smallcheck-style test system in order to better narrow down errors in long sequences of calls.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2010-07-30T06:16:00+01:00" pubdate data-updated="true">30 Jul 2010</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/smarkets/'>smarkets</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><div class="ps">I am often available for consulting work. Check out my <a href="/about.html">resume</a>.</div>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'scattered-thoughts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://scattered-thoughts.net/blog/2010/07/30/smarkets-api-documentation/';
        var disqus_url = 'http://scattered-thoughts.net/blog/2010/07/30/smarkets-api-documentation/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-18515092-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>