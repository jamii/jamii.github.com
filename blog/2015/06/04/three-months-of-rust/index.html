
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Three months of Rust - Scattered Thoughts</title>
  <meta name="author" content="Jamie Brandon">

  
  <meta name="description" content="I work on Eve, a functional-relational programming language and environment. Since the Eve editor has to run in a browser we built the first few &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://scattered-thoughts.net/blog/2015/06/04/three-months-of-rust">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/jamii" rel="subscribe-github" title="@jamii on GitHub" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
<ul class="subscribe">
  <li><a href="https://twitter.com/jamiiecb" rel="subscribe-twitter" title="@jamiiecb on Twitter" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 512 512"><path class="social" d="M0.001,334.932c33.327,30.816,118.891,59.981,188.517-8.271c-12.52,1.955-22.972-0.416-30.913-8.269
  c-7.531-7.465-7.945-15.182-3.914-22.202c3.275-5.725,10.184-9.741,16.977-13.934c-12.323,2.285-22.829,1.095-32.218-3.706
  c-12.604-6.444-24.863-13.228-28.3-27.207c7.71-8.112,16.28-15.359,34.831-12.627c-17.45-5.83-33.087-13.429-44.41-24.815
  c-11.028-11.091-12.163-18.302-13.932-26.996c9.632-3.567,19.688-5.421,30.478-4.353c-24.397-12.476-34.757-29.63-40.487-48.325
  c-1.731-5.652-2.044-11.03-1.31-16.545c98.826,37.305,145.11,64.109,170.662,89.251c11.496-30.589,38.3-99.868,78.371-123.646
  c0.191,3.77-1.309,7.837-4.357,12.189c11.863-6.609,21.125-17.188,37.445-16.98c-1.879,7.723-7.279,13.904-17.85,17.854
  c10.662-4.084,21.463-7.545,32.65-9.578c10.375-1.881,10.229,6.304,4.355,10.444c-11.916,8.412-24.578,9.456-37.006,13.498
  c38.105,0.949,69.266,18.994,93.604,58.343c8.088,13.074,13.52,26.149,14.807,40.487c16.254,4.563,32.426,5.494,48.76,2.61
  c4.475-0.796,8.645-1.63,12.627-3.482c-6.354,9.529-13.686,17.356-23.947,20.899c-9.811,3.387-19.637,6.688-30.473,6.968
  c17.641,6.675,37.082,7.045,57.033,5.659c-24.402,23.486-43.08,22.922-61.824,22.642c-8.221,34.703-25.025,69.315-60.52,101.005
  c-46.559,41.569-96.678,61.397-148.457,65.742c-48.552,4.07-95.488,3.512-146.726-20.464
  C56.486,393.349,24.648,368.884,0.001,334.932L0.001,334.932z"/></svg></a></li>
</ul>
  
  
  
  
  
<ul class="main-navigation">
  <li><a href="/"><header><h2 style="font-weight: normal; color: #BBB;">scattered thoughts</h2></header></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Three months of Rust</h1>
      
    
  </header>


<div class="entry-content"><p>I work on <a href="http://incidentalcomplexity.com/">Eve</a>, a functional-relational programming language and environment. Since the Eve editor has to run in a browser we built the first few versions entirely in javascript. This has been pretty painful, so a little over three months ago we started looking at other options.</p>

<p>The only hard requirements for the runtime are a) we need control over memory layout and b) we need to safely execute untrusted Eve code. Preemptive threads and the ability to compile to efficient javascript would also be valuable.</p>

<p>Javascript <em>can</em> support manual memory layout but provides very little help in getting it right. Native objects have some <a href="https://news.ycombinator.com/item?id=8793817">necessary limitations</a> and asm.js is impractical to write by hand.</p>

<p>C can run in the browser via Emscripten but the available evidence suggests that writing secure C is not a thing that mortals are good at.</p>

<p>Rust is an unknown. It provides control over memory layout, has a community with a strong focus on safety and <em>may</em> support Emscripten in the future. It also promises a minimum of <a href="http://www.urbandictionary.com/define.php?term=footgun&amp;defid=7493319">footguns</a>, which is an attractive feature after many months of javascript and ArrayBuffers. Our initial experiments were promising, so we decided that in the next version of Eve we would write the query planner and runtime in Rust.</p>

<p>(&ldquo;You should look at language X!&rdquo;. We did, and then we decided to use Rust. We can still be friends.)</p>

<p>There are a number of things that made this much less risky than it sounds. First, the query planner is on the way to being bootstrapped and the remaining runtime is only a few thousand lines of code. Most of the development time is spent experimenting with different language semantics and evaluation strategies, rather than building up a large codebase that would tie us to Rust. Second, we have two escape hatches if Rust doesn&rsquo;t work out. We can use the FFI to gradually port components to C, or we can use the websocket interface to the editor to gradually port components to javascript.</p>

<p>So here is what I think after three months of working with Rust full-time. TLDR: mostly impressive, a few worrying quirks, probably the best option for us right now.</p>

<h2>Community</h2>

<p>The Rust community seems to be populated entirely by human beings. I have no idea how this was done. I suspect Graydon Hoare deserves a large share of the credit for leading by example but everyone I have interacted with in the community has been friendly and patient.</p>

<p>Despite my concerns over the size and complexity of the compiler and the LLVM toolchain, I haven&rsquo;t encountered any compiler bugs and only a <a href="https://github.com/rust-lang/rust/issues/24557">single bug</a> in the standard library. The community&rsquo;s attitude towards reliability and safety is by far the strongest point in favour of us continuing to use Rust.</p>

<h2>Tooling</h2>

<p>Compile times are brutal. For our 2400 loc it takes 20s for a dev build and 70s for a release build. Word is that compile time just hasn&rsquo;t been a focus so far and will improve in future releases. Type checking occurs very early in that 20s so running <code>cargo build</code> in a loop gives reasonably fast feedback on type errors, but any time we want to add an extra print statement we pay the full price. Moving the Eve editor into Rust would simplify the overall architecture but the people writing the editor refuse to wait 20s for a page refresh.</p>

<p>Error messages are better than any other tool I have used. For most errors the compiler not only clearly explains the problem but also offers the correct solution. There is no secret sauce, it&rsquo;s just the result of long hours from the compiler team and a culture of caring about usability.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">relation</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">110</span><span class="o">:</span><span class="m">29</span><span class="o">:</span> <span class="m">110</span><span class="o">:</span><span class="m">38</span> <span class="n">error</span><span class="o">:</span> <span class="n">unresolved</span> <span class="n">name</span> <span class="err">`</span><span class="n">before_op</span><span class="err">`</span><span class="p">.</span> <span class="n">Did</span> <span class="n">you</span> <span class="n">mean</span> <span class="err">`</span><span class="n">before_opt</span><span class="err">`</span><span class="o">?</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">relation</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">110</span>                             <span class="n">before_op</span> <span class="o">=</span> <span class="n">befores</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">relation</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">121</span><span class="o">:</span><span class="m">29</span><span class="o">:</span> <span class="m">121</span><span class="o">:</span><span class="m">33</span> <span class="n">error</span><span class="o">:</span> <span class="n">attempted</span> <span class="n">to</span> <span class="n">take</span> <span class="n">value</span> <span class="n">of</span> <span class="n">method</span> <span class="err">`</span><span class="n">iter</span><span class="err">`</span> <span class="n">on</span> <span class="k">type</span> <span class="err">`</span><span class="n">collections</span><span class="o">::</span><span class="n">vec</span><span class="o">::</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">collections</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;</span><span class="err">`</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">relation</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">121</span>         <span class="k">let</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">iter</span><span class="p">.</span><span class="n">position</span><span class="p">(</span><span class="o">|</span><span class="n">my_name</span><span class="o">|</span> <span class="o">&amp;</span><span class="n">my_name</span><span class="p">[..]</span> <span class="o">==</span> <span class="n">name</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>                                                <span class="o">^~~~</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">relation</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">121</span><span class="o">:</span><span class="m">29</span><span class="o">:</span> <span class="m">121</span><span class="o">:</span><span class="m">33</span> <span class="n">help</span><span class="o">:</span> <span class="n">maybe</span> <span class="n">a</span> <span class="err">`</span><span class="p">()</span><span class="err">`</span> <span class="n">to</span> <span class="n">call</span> <span class="n">it</span> <span class="n">is</span> <span class="n">missing</span><span class="o">?</span> <span class="n">If</span> <span class="n">not</span><span class="p">,</span> <span class="n">try</span> <span class="n">an</span> <span class="n">anonymous</span> <span class="n">function</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">value</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">14</span><span class="o">:</span><span class="m">15</span><span class="o">:</span> <span class="m">14</span><span class="o">:</span><span class="m">20</span> <span class="n">error</span><span class="o">:</span> <span class="n">cannot</span> <span class="n">move</span> <span class="n">out</span> <span class="n">of</span> <span class="n">borrowed</span> <span class="n">content</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">value</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">14</span>         <span class="n">match</span> <span class="o">*</span><span class="n">self</span> <span class="p">{</span>
</span><span class='line'>                              <span class="o">^~~~~</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">value</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">17</span><span class="o">:</span><span class="m">27</span><span class="o">:</span> <span class="m">17</span><span class="o">:</span><span class="m">33</span> <span class="k">note</span><span class="o">:</span> <span class="n">attempting</span> <span class="n">to</span> <span class="n">move</span> <span class="n">value</span> <span class="n">to</span> <span class="n">here</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">value</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">17</span>             <span class="n">Value</span><span class="o">::</span><span class="n">String</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">string</span><span class="p">.</span><span class="n">fmt</span><span class="p">(</span><span class="n">formatter</span><span class="p">),</span>
</span><span class='line'>                                          <span class="o">^~~~~~</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">value</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">17</span><span class="o">:</span><span class="m">27</span><span class="o">:</span> <span class="m">17</span><span class="o">:</span><span class="m">33</span> <span class="n">help</span><span class="o">:</span> <span class="n">to</span> <span class="n">prevent</span> <span class="n">the</span> <span class="n">move</span><span class="p">,</span> <span class="k">use</span> <span class="err">`</span><span class="n">ref</span> <span class="n">string</span><span class="err">`</span> <span class="n">or</span> <span class="err">`</span><span class="n">ref</span> <span class="k">mut</span> <span class="n">string</span><span class="err">`</span> <span class="n">to</span> <span class="n">capture</span> <span class="n">value</span> <span class="n">by</span> <span class="n">reference</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cargo is solid. Building projects, versioning dependencies and running tests/benchmarks are all easy. I would like to see <code>cargo bench</code> produce comparison graphs (like <a href="https://github.com/garybernhardt/readygo">readygo</a>). I&rsquo;m also looking forward to <a href="https://github.com/nrc/rustfmt">rustfmt</a> since most editors currently do a pretty poor job of auto-indenting.</p>

<p>Javascript profilers tend to tell me that the Eve runtime spends 100% of its time in <code>main</code> and calls no other functions. With Rust I get to use valgrind and perf which actually return useful information.</p>

<p>Debugging is less exciting &ndash; both GDB and LLDB work and there is a <a href="https://michaelwoerister.github.io/2015/03/27/rust-xxdb.html">macros package</a> that makes them more useful but the Chrome debugger is still far more useable (when it doesn&rsquo;t crash).</p>

<h2>Ownership</h2>

<p>One of the unique features of Rust is that the type system tracks ownership of data. Shared mutability is the root of many bugs and vulnerabilities, especially in concurrent environments. Functional languages address this by removing or strictly controlling mutability. Rust addresses this by tracking and controlling sharing. See the <a href="https://doc.rust-lang.org/book/ownership.html">documentation</a> for the gory details.</p>

<p>Most code I write now compiles without error. Most errors I see are clearly mistakes on my part and are easy to fix. About once a week, I hit an error that causes some headscratching. In most case I fume for a while before realising that I was trying to blow my foot off.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">205</span><span class="o">:</span><span class="m">70</span><span class="o">:</span> <span class="m">205</span><span class="o">:</span><span class="m">81</span> <span class="n">error</span><span class="o">:</span> <span class="err">`</span><span class="n">outer_items</span><span class="err">`</span> <span class="n">does</span> <span class="n">not</span> <span class="n">live</span> <span class="n">long</span> <span class="n">enough</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">205</span>                     <span class="n">output_pairs</span><span class="p">.</span><span class="n">push</span><span class="p">((</span><span class="o">&amp;</span><span class="n">aggregate</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fields</span><span class="p">[..],</span> <span class="o">&amp;</span><span class="n">outer_items</span><span class="p">[..]));</span>
</span><span class='line'>
</span><span class='line'>                                                                                     <span class="o">^~~~~~~~~~~</span>
</span><span class='line'><span class="k">note</span><span class="o">:</span> <span class="n">in</span> <span class="n">expansion</span> <span class="n">of</span> <span class="k">for</span> <span class="k">loop</span> <span class="n">expansion</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">172</span><span class="o">:</span><span class="m">17</span><span class="o">:</span> <span class="m">212</span><span class="o">:</span><span class="m">18</span> <span class="k">note</span><span class="o">:</span> <span class="n">expansion</span> <span class="n">site</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">203</span><span class="o">:</span><span class="m">47</span><span class="o">:</span> <span class="m">212</span><span class="o">:</span><span class="m">18</span> <span class="k">note</span><span class="o">:</span> <span class="n">reference</span> <span class="n">must</span> <span class="k">be</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">block</span> <span class="n">suffix</span> <span class="n">following</span> <span class="n">statement</span> <span class="m">3</span> <span class="n">at</span> <span class="m">203</span><span class="o">:</span><span class="m">46.</span><span class="p">..</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">203</span>                         <span class="p">).</span><span class="n">collect</span><span class="o">::&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">204</span>                     <span class="k">let</span> <span class="n">outer_items</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">outer_values</span><span class="p">];</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">205</span>                     <span class="n">output_pairs</span><span class="p">.</span><span class="n">push</span><span class="p">((</span><span class="o">&amp;</span><span class="n">aggregate</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fields</span><span class="p">[..],</span> <span class="o">&amp;</span><span class="n">outer_items</span><span class="p">[..]));</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">206</span>                     <span class="k">if</span> <span class="n">aggregate</span><span class="p">.</span><span class="n">selects_inner</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">207</span>                         <span class="n">output_pairs</span><span class="p">.</span><span class="n">push</span><span class="p">((</span><span class="o">&amp;</span><span class="n">aggregate</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">fields</span><span class="p">[..],</span> <span class="n">group</span><span class="p">))</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">208</span>                     <span class="p">}</span>
</span><span class='line'>                <span class="p">...</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">204</span><span class="o">:</span><span class="m">58</span><span class="o">:</span> <span class="m">212</span><span class="o">:</span><span class="m">18</span> <span class="k">note</span><span class="o">:</span> <span class="p">...</span><span class="n">but</span> <span class="n">borrowed</span> <span class="n">value</span> <span class="n">is</span> <span class="n">only</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">block</span> <span class="n">suffix</span> <span class="n">following</span> <span class="n">statement</span> <span class="m">4</span> <span class="n">at</span> <span class="m">204</span><span class="o">:</span><span class="m">57</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">204</span>                     <span class="k">let</span> <span class="n">outer_items</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="n">outer_values</span><span class="p">];</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">205</span>                     <span class="n">output_pairs</span><span class="p">.</span><span class="n">push</span><span class="p">((</span><span class="o">&amp;</span><span class="n">aggregate</span><span class="p">.</span><span class="n">outer</span><span class="p">.</span><span class="n">fields</span><span class="p">[..],</span> <span class="o">&amp;</span><span class="n">outer_items</span><span class="p">[..]));</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">206</span>                     <span class="k">if</span> <span class="n">aggregate</span><span class="p">.</span><span class="n">selects_inner</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">207</span>                         <span class="n">output_pairs</span><span class="p">.</span><span class="n">push</span><span class="p">((</span><span class="o">&amp;</span><span class="n">aggregate</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">fields</span><span class="p">[..],</span> <span class="n">group</span><span class="p">))</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">208</span>                     <span class="p">}</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">view</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="m">209</span>                     <span class="k">let</span> <span class="k">mut</span> <span class="n">tuples</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">output_pairs</span><span class="p">.</span><span class="n">len</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>It took me a while to realise that this error is trying to tell me is that <code>output_pairs</code> is declared one line before <code>outer_items</code>. Declarations for a block are freed in reverse order, so <code>outer_items</code> will be freed first and there will be a dangling pointer when <code>output_pairs</code> is freed. All I have to do to fix it is declare <code>output_pairs</code> after <code>outer_items</code>.</p>

<p>Most of my confusion looks like this. There is some pattern that I didn&rsquo;t think about before and now that I understand it I won&rsquo;t struggle with that kind of error again. As the language matures I expect that these patterns will be collected and documented.</p>

<p>There are also some patterns that the borrow checker can&rsquo;t understand (or, more accurately, there is no matching pattern in the standard library). This is a heavily simplified version of a common pattern in the query engine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">step</span><span class="o">&lt;</span><span class="err">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">table</span><span class="o">:</span> <span class="o">&amp;</span><span class="err">&#39;</span><span class="n">a</span> <span class="p">[</span><span class="n">String</span><span class="p">],</span> <span class="n">state</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;&amp;</span><span class="err">&#39;</span><span class="n">a</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">results</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">table</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">results</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">).</span><span class="n">to_owned</span><span class="p">()).</span><span class="n">collect</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">table</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span> <span class="c1">// some complicated condition</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">step</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">1.</span><span class="p">.],</span> <span class="n">state</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;some new thing&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">();</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="n">step</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">1.</span><span class="p">.],</span> <span class="n">state</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">let</span> <span class="n">table</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span> <span class="s">&quot;b&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span> <span class="s">&quot;c&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span> <span class="s">&quot;d&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">()];</span>
</span><span class='line'>   <span class="k">let</span> <span class="k">mut</span> <span class="n">state</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[];</span>
</span><span class='line'>   <span class="k">let</span> <span class="k">mut</span> <span class="n">results</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[];</span>
</span><span class='line'>   <span class="n">step</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[..],</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">state</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">results</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which produces this error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">10</span><span class="o">:</span><span class="m">21</span><span class="o">:</span> <span class="m">10</span><span class="o">:</span><span class="m">22</span> <span class="n">error</span><span class="o">:</span> <span class="err">`</span><span class="n">s</span><span class="err">`</span> <span class="n">does</span> <span class="n">not</span> <span class="n">live</span> <span class="n">long</span> <span class="n">enough</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">10</span>         <span class="n">state</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>                              <span class="o">^</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">1</span><span class="o">:</span><span class="m">95</span><span class="o">:</span> <span class="m">14</span><span class="o">:</span><span class="m">2</span> <span class="k">note</span><span class="o">:</span> <span class="n">reference</span> <span class="n">must</span> <span class="k">be</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">lifetime</span> <span class="err">&#39;</span><span class="n">a</span> <span class="k">as</span> <span class="n">defined</span> <span class="n">on</span> <span class="n">the</span> <span class="n">block</span> <span class="n">at</span> <span class="m">1</span><span class="o">:</span><span class="m">94.</span><span class="p">..</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">1</span> <span class="k">fn</span> <span class="n">step</span><span class="o">&lt;</span><span class="err">&#39;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">table</span><span class="o">:</span> <span class="o">&amp;</span><span class="err">&#39;</span><span class="n">a</span> <span class="p">[</span><span class="n">String</span><span class="p">],</span> <span class="n">state</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;&amp;</span><span class="err">&#39;</span><span class="n">a</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">results</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">2</span>     <span class="k">if</span> <span class="n">table</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">3</span>         <span class="n">results</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">).</span><span class="n">to_owned</span><span class="p">()).</span><span class="n">collect</span><span class="p">());</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">4</span>     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">table</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="o">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span> <span class="c1">// some complicated condition</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">5</span>         <span class="n">state</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">6</span>         <span class="n">step</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">1.</span><span class="p">.],</span> <span class="n">state</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
</span><span class='line'>         <span class="p">...</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">9</span><span class="o">:</span><span class="m">40</span><span class="o">:</span> <span class="m">13</span><span class="o">:</span><span class="m">6</span> <span class="k">note</span><span class="o">:</span> <span class="p">...</span><span class="n">but</span> <span class="n">borrowed</span> <span class="n">value</span> <span class="n">is</span> <span class="n">only</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">block</span> <span class="n">suffix</span> <span class="n">following</span> <span class="n">statement</span> <span class="m">0</span> <span class="n">at</span> <span class="m">9</span><span class="o">:</span><span class="m">39</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">9</span>         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;some new thing&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">();</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">10</span>         <span class="n">state</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">11</span>         <span class="n">step</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">1.</span><span class="p">.],</span> <span class="n">state</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">12</span>         <span class="n">state</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">anon</span><span class="o">&gt;:</span><span class="m">13</span>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The core problem is that I&rsquo;m pushing a value <code>s</code> into a vector which lives longer than <code>s</code>. The borrow checker isn&rsquo;t capable of proving that I remove the value again before it is freed. I could build a wrapper around the vector library that understands this pattern, or I could just promise the borrow checker that I know what I&rsquo;m doing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;some new thing&quot;</span><span class="p">.</span><span class="n">to_owned</span><span class="p">();</span>
</span><span class='line'><span class="c1">// promise the borrow checker that we will pop s before we exit this scope</span>
</span><span class='line'><span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">mem</span><span class="o">::</span><span class="n">transmute</span><span class="o">::&lt;&amp;</span><span class="n">String</span><span class="p">,</span> <span class="o">&amp;</span><span class="err">&#39;</span><span class="n">a</span> <span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'><span class="n">state</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="n">step</span><span class="p">(</span><span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="m">1.</span><span class="p">.],</span> <span class="n">state</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
</span><span class='line'><span class="n">state</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>I like this pragmatic approach to safety. When the type-system understands what I&rsquo;m doing I get the full benefit. When it doesn&rsquo;t I can escape and do my own reasoning. If a particular pattern appears frequently I can put that reasoning into a library (like <a href="https://doc.rust-lang.org/std/cell/struct.RefCell.html">RefCell</a> or <a href="https://doc.rust-lang.org/std/rc/struct.Rc.html">Rc</a>) and expose a safe interface that the type system understands. It feels like having an extensible type system that can learn to understand the way each project manages memory.</p>

<h2>Control</h2>

<p>Rust has <a href="http://en.wikipedia.org/wiki/Algebraic_data_type">algebraic data-types</a> that layout data consecutively. Pointers are opt-in. Gaining a similar level of control in javascript <em>is</em> possible but it requires some mightily unpleasant gymnastics. Rust feels like a high-level language most of the time but manages to do it without vomiting all over the cache.</p>

<p>Rust doesn&rsquo;t help at all with <a href="http://bitsquid.blogspot.com/2010/02/blob-and-i.html">blobs</a> though. They have to be handled with &lsquo;unsafe&rsquo; code which subverts the normal Rust guarantees. The unsafe code could be wrapped in a library (like <a href="https://github.com/frankmcsherry/columnar">columnar</a>) to ensure that clients use it correctly but the library code itself will still need very careful review. And speaking of review&hellip;</p>

<h2>Unsafe</h2>

<p>There is a very recent effort to define <a href="http://cglab.ca/~abeinges/blah/rust-unsafe-intro/">exactly what unsafe code has to do</a> to not ruin all the guarantees that Rust works so hard to provide. The list of <a href="https://doc.rust-lang.org/reference.html#behavior-considered-undefined">undefined behaviour</a> is long and scary. It looks like consensus and documentation is on the way but until then &hellip; here be dragons.</p>

<h2>Zero cost</h2>

<p>Rust provides a lot of high-level abstractions which LLVM then optimises away. For example, large chains of iterator functions usually optimise into imperative loops. And the word &lsquo;usually&rsquo; is what makes me worry. So far Rust has behaved but I have been bitten badly by other &lsquo;sufficiently smart&rsquo; compilers.</p>

<p>Modern machines are a huge pile of opaque and unreliable heuristics and the current trend is to add more and more layers on top. The vast majority of systems are built this way and it is by all accounts a successful strategy. That doesn&rsquo;t mean I have to like it.</p>

<h2>Syntax</h2>

<p>Doesn&rsquo;t matter that much. I got used to it.</p>

<p>There is a hint of object-orientation in that one can write <code>foo.bar(x, y, z)</code> and it desugars to something like <code>bar(foo, x, y, z)</code>. If it was only sugar I would be happy enough, but it also has non-trivial interactions with namespaces, trait dispatch, auto-deref and auto-borrow which I will go into below. There is a whole pile of intertwined design decisions here that have been made for totally valid ergonomic reasons but give rise to some interactions that make me nervous.</p>

<h2>Namespaces</h2>

<p>There are effectively three kinds of namespaces.</p>

<p>Modules behave like most static languages &ndash; you can call functions using their full path or you can import them under a short name eg</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="o">::</span><span class="n">my</span><span class="o">::</span><span class="n">global</span><span class="o">::</span><span class="n">namespace</span><span class="o">::</span><span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">my</span><span class="o">::</span><span class="n">global</span><span class="o">::</span><span class="n">namespace</span><span class="p">;</span>
</span><span class='line'><span class="n">namespace</span><span class="o">::</span><span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">my</span><span class="o">::</span><span class="n">global</span><span class="o">::</span><span class="n">namespace</span><span class="o">::</span><span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is some funkiness around how modules are structured and how they are scoped relative to each other that I haven&rsquo;t taken the trouble to understand. I only need one level of namespaces.</p>

<p>Types can also be namespaces. You can add a method to a type and access it either through the type or through the dot syntax.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">struct</span> <span class="n">Bar</span><span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">Bar</span><span class="p">{</span>
</span><span class='line'>  <span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{...}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Bar</span><span class="o">::</span><span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
</span><span class='line'><span class="n">bar</span><span class="p">.</span><span class="n">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lastly, traits can attach methods to types. To prevent collisions, the methods are namespaced by the trait.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">struct</span> <span class="n">Bar</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">trait</span> <span class="n">Foo</span><span class="p">{</span>
</span><span class='line'>  <span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">Foo</span> <span class="k">for</span> <span class="n">Bar</span> <span class="p">{...}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Foo</span><span class="o">::</span><span class="n">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">use</span> <span class="n">Foo</span><span class="p">;</span> <span class="c1">// import foo for the dot syntax</span>
</span><span class='line'><span class="n">bar</span><span class="p">.</span><span class="n">foo</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not unreasonable so far. It can sometimes be hard to track down where a particular method came from but the dispatch is at least direct. No inheritance or prototype chains to deal with.</p>

<h2>Traits</h2>

<p>Haskell suffers from an excess of magic. Typeclass methods can dispatch on the type of any argument (or on the return type!) but the types are usually inferred. Reading haskell code that overuses typeclasses may require running the inference algorithms in your head, which is difficult and error-prone. This can also lead to bugs when an edit in one place changes a type, causing a different instance to be silently selected somewhere else (Don Stewart warned against this in his <a href="http://code.haskell.org/~dons/talks/padl-keynote-2012-01-24.pdf">PADL keynote</a>).</p>

<p>OCaml leans entirely the other way. Code is very readable and maintainable because all the information needed to follow the dispatch is written down explicitly. On the other hand, printing a simple data-structure can require chaining together multiple lines of functors to get to the correct function.</p>

<p>Rust has very similar capabilities to haskell but (so far) abuses them less often. There are only a few cases so far where I felt lost in types &ndash; <a href="http://cyderize.github.io/rust-websocket/doc/websocket/index.html">rust-websocket</a> being the biggest offender.</p>

<p>Traits have different syntax for the distinguished <code>self</code> argument and I never get it right. Nor am I totally sure what the tradeoffs are between having a <code>self</code> argument and not. You can put constraints directly on <code>self</code> but for other arguments you must use a <code>where</code> clause:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">trait</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">do_stuff</span><span class="o">&lt;</span><span class="n">A</span><span class="o">:</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="o">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">:</span> <span class="n">B</span><span class="p">)</span> <span class="p">{</span> <span class="p">..</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">trait</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">fn</span><span class="p">(</span><span class="n">a</span><span class="o">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">:</span> <span class="n">B</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">do_stuff</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="o">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">:</span> <span class="n">B</span><span class="p">)</span> <span class="n">where</span> <span class="n">Foo</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">..</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some kinds of constraints <a href="https://github.com/rust-lang/rfcs/blob/master/text/0135-where.md">cannot be used in where clauses</a>, so I <em>believe</em> the former is strictly more powerful.</p>

<p>It also affect associated types:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">next_path</span><span class="o">&lt;</span><span class="n">N</span><span class="o">:</span> <span class="n">Iterator</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nibbles</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">u32</span> <span class="n">where</span> <span class="o">&lt;</span><span class="n">N</span> <span class="k">as</span> <span class="n">Iterator</span><span class="o">&gt;::</span><span class="n">Item</span> <span class="o">=</span> <span class="k">u8</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">next_path</span><span class="o">&lt;</span><span class="n">N</span><span class="o">:</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">=</span><span class="k">u8</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">nibbles</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">N</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">u32</span>
</span></code></pre></td></tr></table></div></figure>


<p>At the time I wrote that code, only the latter version worked. Which means that <code>Iterator</code> <em>has</em> to have chosen to use a self type for this function to be written. It looks like there may be cases where choosing the wrong argument to promote to <code>self</code> can prevent me from writing certain constraints?</p>

<h2>Auto-deref</h2>

<p>Self types are further privileged. Suppose we have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">trait</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">fn</span> <span class="n">foo</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">x</span><span class="p">.</span><span class="n">foo</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>If <code>x</code> implements <code>Foo</code> then life is simple. If <code>x</code> doesn&rsquo;t implement <code>Foo</code> but does implement <code>Deref</code> then the compiler will change the call to <code>x.deref().foo()</code>. This continues with <code>x.deref().deref().foo()</code> and so on until compiler finds a type that doesn&rsquo;t implement <code>Deref</code> or a type that does implement <code>Foo</code>. This is great ergonomically &ndash; it means you can call methods on a smart pointer as it were the pointed-at object. But it only works on the self argument &ndash; other arguments have to be manually deref-ed.</p>

<p>Similarly, if a method is declared to take <code>&amp;self</code> or <code>&amp;mut self</code> the compiler will insert the appropriate borrow before making the call. <code>foo.bar()</code> could desugar to <code>bar(foo)</code> or <code>bar(&amp;foo)</code> or <code>bar(&amp;mut foo)</code> depending on the type of <code>bar</code>.</p>

<p>Auto-deref and auto-borrow can interact unpleasantly with traits and inference. Here is a real example that totally confused me:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span><span class="o">:</span>
</span><span class='line'><span class="n">print_type_of</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">to_owned</span><span class="p">());</span> <span class="c1">// prints String</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="s">&quot;foo&quot;</span><span class="p">];</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">xs</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">print_type_of</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">to_owned</span><span class="p">());</span> <span class="c1">// prints String</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">let</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="s">&quot;foo&quot;</span><span class="p">];</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">xs</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">print_type_of</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">to_owned</span><span class="p">());</span> <span class="c1">// prints &amp;str</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s going on? The standard library has the following implementations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">ToOwned</span> <span class="k">for</span> <span class="n">str</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">type</span> <span class="n">Owned</span> <span class="o">=</span> <span class="n">String</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">ToOwned</span> <span class="k">for</span> <span class="n">T</span> <span class="n">where</span> <span class="n">T</span><span class="o">:</span> <span class="n">Clone</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">type</span> <span class="n">Owned</span> <span class="o">=</span> <span class="n">T</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">Clone</span> <span class="k">for</span> <span class="o">&amp;</span><span class="n">T</span>
</span></code></pre></td></tr></table></div></figure>


<p>The type of <code>x</code> in the first two examples is <code>&amp;str</code> which auto-derefs to <code>str</code> and gets <code>Owned = String</code>. The type of <code>x</code> in the third example is <code>&amp;&amp;str</code> (because iter borrows elements of the vec). <code>&amp;str</code> implements <code>Clone</code> so <code>&amp;&amp;str</code> implements <code>ToOwned</code> directly and does not auto-deref to <code>str</code>.</p>

<p>This is a risk for traits in general, but auto-deref exacerbates it by creating multiple types that might choose an instance. In this case it caused a type error but you can imagine cases where adding a new trait implementation silently changes the selected instance of a seemingly unrelated call in far away code. Very difficult for code review to catch.</p>

<p>A similar mistake can happen if both the dereferenced type and the pointer type implement a method with the same name, but it looks like the standard library authors are aware of this and have stopped implementing methods directly on pointer types.</p>

<h2>Learning curve</h2>

<p>The borrow checker was initially huge impediment to productivity but I reached the break-even point around the second month. Ownership and borrowing have become intuitive and I no longer have to contort designs around them.</p>

<p>Safety is an enormous productivity boon. I&rsquo;ve checked in a total of 10k lines of Rust code and written many more experiments that didn&rsquo;t make it to master, and in that time I haven&rsquo;t had a single segfault, nor any bugs caused by accidental mutation, aliasing, type errors or null pointers. The vast majority of typing mistakes are also caught at compile time (the exceptions being interactions with dynamically typed Eve data).</p>

<p>Despite the restrictions of the type system, I am more productive in Rust than I am in either Javascript or Haskell. It manages somehow to hit a sweet spot between safety and ease of use.</p>

<p>By far, the feature I miss most is interactive development. The <a href="https://github.com/murarth/rusti">repl</a> is only a thin layer over the compiler &ndash; it&rsquo;s equally slow and nukes all state between every eval. Adding interactivity to a language that wasn&rsquo;t designed for it is generally unsatisfying so this is not something that it likely to be fixed.</p>

<h2>For Eve</h2>

<p>One of the core values of Eve is radical simplicity, in the same vein as the <a href="http://www.vpri.org/pdf/tr2011004_steps11.pdf">STEPS</a> and <a href="http://boom.cs.berkeley.edu/">BOOM</a> projects. We have to make compromises if we want to ever ship, but sitting atop Rust, LLVM and possibly Emscripten feels like a pretty big compromise.</p>

<p>The complexity in Rust exists to create a general-purpose systems language with an array of features and zero-cost abstractions that are incredibly useful for building large projects. But we aren&rsquo;t building a large project, by design, and we don&rsquo;t <em>need</em> most of the features.</p>

<p>The only places where we absolutely need manual layout so far are for Eve data and indexes. Those are nicely self-contained &ndash; no pointers to the outside world &ndash; and have a well-defined life-cycle. I wonder how far we could get with an approach like <a href="http://terralang.org/">Terra</a>, writing the core data-structures and algorithms in some scary unsafe language and interact with them safely from a managed language. With a staged approach we could build just the safety mechanisms that we need and avoid carrying around the complexity of the rest. Javascript seems to have all the features needed to make this kind of approach work but it doesn&rsquo;t have the tools needed to make it bearable. Creating one programming language is hard enough &ndash; we probably shouldn&rsquo;t start on another.</p>

<p>Regardless, Rust is an incredible language in general. Even if we end up using something else for Eve, I can see myself using Rust for other projects where I care about performance, safety or reliability.</p>
</div>


</article>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jamie Brandon
</p>

</footer>
  

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-18515092-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</body>
</html>
