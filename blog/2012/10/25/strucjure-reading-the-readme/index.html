
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Strucjure: reading the readme - Scattered Thoughts</title>
	<meta name="author" content="Jamie Brandon">

	
	<meta name="description" content="I just released strucjure, a clojure library and DSL for parsing and pattern matching based on Ometa. The readme on github has detailed descriptions &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Scattered Thoughts</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:scattered-thoughts.net">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="email" href="mailto:jamie@scattered-thoughts.net" title="Email">Email</a>
		
		
		
		
		
		<a class="github" href="https://github.com/jamii" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:scattered-thoughts.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Strucjure: reading the readme</h1>
	<div class="entry-content"><p>I just released <a href="https://github.com/jamii/strucjure">strucjure</a>, a clojure library and DSL for parsing and pattern matching based on <a href="http://lambda-the-ultimate.org/node/2477">Ometa</a>.</p>

<p>The readme on github has detailed descriptions of the syntax etc which I won&rsquo;t repeat here. What I do want to do is run through a realistic example.</p>

<!--more-->


<p>The readme has a large number of examples and I want to be sure that these are all correct and up to date. As part of the test-suite for strucjure I parse the <a href="https://raw.github.com/jamii/strucjure/master/README.md">readme source</a>, pull out all the examples and make sure that they all run correctly and return the expected output.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jamie@alien:~/strucjure<span class="nv">$ </span>lein <span class="nb">test </span>strucjure.test
</span><span class='line'>WARNING: newline already refers to: <span class="c">#&#39;clojure.core/newline in namespace: strucjure.test, being replaced by: #&#39;strucjure.test/newline</span>
</span><span class='line'>
</span><span class='line'>lein <span class="nb">test </span>strucjure.test
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 166 assertions.
</span><span class='line'>0 failures, 0 errors.
</span></code></pre></td></tr></table></div></figure>


<p>The readme parser is pretty simple. Since I control both the parser and the readme source so it doesn&rsquo;t need to be bullet-proof, just the simplest thing that will get the job done. Strucjure is very bare-bones at the moment though so we have to create a lot of simple views that really belong in a library somewhere.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">space</span>
</span><span class='line'>  <span class="sc">\s</span><span class="nv">pace</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">newline</span>
</span><span class='line'>  <span class="sc">\n</span><span class="nv">ewline</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">not-newline</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">not </span><span class="sc">\n</span><span class="nv">ewline</span><span class="p">)</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">line</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">not </span><span class="p">[])</span> <span class="c1">; have to consume at least one char</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">prefix</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">zero-or-more</span> <span class="nv">not-newline</span><span class="p">)</span> <span class="nv">?line</span><span class="p">)</span>
</span><span class='line'>               <span class="o">&amp;</span> <span class="p">((</span><span class="nf">optional</span> <span class="nv">newline</span><span class="p">)</span> <span class="nv">?end</span><span class="p">)))</span>
</span><span class='line'>  <span class="nv">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">indented-line</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prefix</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">one-or-more</span> <span class="nv">space</span><span class="p">)</span> <span class="nv">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nf">line</span> <span class="nv">?line</span><span class="p">))</span>
</span><span class='line'>  <span class="nv">line</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We want a tokeniser for various parts of the readme. We could write it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defnview</span> <span class="nv">tokenise</span> <span class="p">[</span><span class="nv">sep</span><span class="p">]</span>
</span><span class='line'>  <span class="c1">;; empty input</span>
</span><span class='line'>  <span class="p">[]</span> <span class="o">&#39;</span><span class="p">(())</span>
</span><span class='line'>  <span class="c1">;; throw away separator, start a new token</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="p">(</span><span class="nf">sep</span> <span class="nv">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">sep</span><span class="p">)</span> <span class="nv">?results</span><span class="p">)]</span> <span class="p">(</span><span class="nb">cons </span><span class="p">()</span> <span class="nv">results</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;; add the current char to the first token</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">?char</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">sep</span><span class="p">)</span> <span class="p">[</span><span class="nv">?result</span> <span class="o">&amp;</span> <span class="nv">?results</span><span class="p">])]</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">cons char </span><span class="nv">result</span><span class="p">)</span> <span class="nv">results</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately in the current implementation of strucjure that recursive call goes on the stack, so this view will blow up on large inputs. For now we just have to implement this view by hand to get access to recur.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">tokenise</span> <span class="p">[</span><span class="nv">sep</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">view/-&gt;Raw</span>
</span><span class='line'>   <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">input</span> <span class="nv">opts</span><span class="p">]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">elems</span> <span class="p">(</span><span class="nb">seq </span><span class="nv">input</span><span class="p">)]</span>
</span><span class='line'>       <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">elems</span> <span class="nv">elems</span>
</span><span class='line'>              <span class="nv">token-acc</span> <span class="nv">nil</span>
</span><span class='line'>              <span class="nv">tokens-acc</span> <span class="nv">nil</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nb">if-let </span><span class="p">[[</span><span class="nv">remaining</span> <span class="nv">_</span><span class="p">]</span> <span class="p">(</span><span class="nf">view/run</span> <span class="nv">sep</span> <span class="nv">elems</span> <span class="nv">opts</span><span class="p">)]</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">recur</span> <span class="nv">remaining</span> <span class="nv">nil</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">reverse </span><span class="nv">token-acc</span><span class="p">)</span> <span class="nv">tokens-acc</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">if-let </span><span class="p">[[</span><span class="nv">elem</span> <span class="o">&amp;</span> <span class="nv">elems</span><span class="p">]</span> <span class="nv">elems</span><span class="p">]</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">recur</span> <span class="nv">elems</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">elem</span> <span class="nv">token-acc</span><span class="p">)</span> <span class="nv">tokens-acc</span><span class="p">)</span>
</span><span class='line'>             <span class="p">[</span><span class="nv">nil</span> <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">reverse </span><span class="nv">token-acc</span><span class="p">)</span> <span class="nv">tokens-acc</span><span class="p">))])))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rest of the parser makes more sense reading in reverse order. We start by splitting up the readme by code delimiters (triple backticks). This gives us chunks of alternating text and code, so we parse every other chunk as a block of code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">code-delim</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prefix</span> <span class="sc">\`</span> <span class="sc">\`</span> <span class="sc">\`</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">:code-delim</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">readme</span>
</span><span class='line'>  <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">code-delim</span><span class="p">)</span> <span class="nv">?chunks</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">apply concat </span><span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">run</span> <span class="nv">code-block</span><span class="p">)</span> <span class="p">(</span><span class="nb">take-nth </span><span class="mi">2</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">chunks</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We only want to look at code blocks that are marked as clojure code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">code-block</span>
</span><span class='line'>  <span class="p">[</span><span class="sc">\c</span> <span class="sc">\l</span> <span class="sc">\o</span> <span class="sc">\j</span> <span class="sc">\u</span> <span class="sc">\r</span> <span class="sc">\e</span> <span class="sc">\n</span><span class="nv">ewline</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nf">code-block-inner</span> <span class="nv">?result</span><span class="p">)]</span>
</span><span class='line'>  <span class="nv">result</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few of the code blocks don&rsquo;t contain examples &ndash; we can detect these because they don&rsquo;t start with a &ldquo;user> &rdquo; prompt. All the other blocks contain a list of examples separated by prompts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">prompt</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prefix</span> <span class="sc">\u</span> <span class="sc">\s</span> <span class="sc">\e</span> <span class="sc">\r</span> <span class="sc">\&gt;</span> <span class="sc">\s</span><span class="nv">pace</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">:prompt</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">code-block-inner</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">prompt</span> <span class="nv">_</span><span class="p">)</span>
</span><span class='line'>       <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">prompt</span><span class="p">)</span> <span class="nv">?chunks</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">run</span> <span class="nv">example</span><span class="p">)</span> <span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">chunks</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">_</span> <span class="c1">;; not a block of examples</span>
</span><span class='line'>  <span class="nv">nil</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>An example consists of an input, which may be on multiple lines, zero or more lines of printed output and finally a result.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">example</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="p">(</span><span class="nf">line</span> <span class="nv">?input-first</span><span class="p">)</span>
</span><span class='line'>   <span class="o">&amp;</span> <span class="p">((</span><span class="nf">zero-or-more-prefix</span> <span class="nv">indented-line</span><span class="p">)</span> <span class="nv">?input-rest</span><span class="p">)</span>
</span><span class='line'>   <span class="o">&amp;</span> <span class="p">((</span><span class="nf">one-or-more-prefix</span> <span class="nv">line</span><span class="p">)</span> <span class="nv">?output-lines</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:input</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">line</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">input-first</span> <span class="nv">input-rest</span><span class="p">)]</span> <span class="p">(</span><span class="nb">print </span><span class="p">(</span><span class="nb">apply str </span><span class="nv">line</span><span class="p">)</span> <span class="sc">\s</span><span class="nv">pace</span><span class="p">)))</span>
</span><span class='line'>   <span class="ss">:prints</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">line</span> <span class="p">(</span><span class="nb">butlast </span><span class="nv">output-lines</span><span class="p">)]</span> <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">apply str </span><span class="nv">line</span><span class="p">))))</span>
</span><span class='line'>   <span class="ss">:result</span> <span class="p">(</span><span class="nf">run</span> <span class="nv">result</span> <span class="p">(</span><span class="nb">last </span><span class="nv">output-lines</span><span class="p">))})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is either a return value or an exception.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; #&quot;[a-zA-Z\.]&quot;</span>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">exception-chars</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">or </span><span class="sc">\.</span>
</span><span class='line'>      <span class="o">#</span><span class="p">(</span><span class="nb">&lt;= </span><span class="p">(</span><span class="nb">int </span><span class="sc">\a</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="sc">\z</span><span class="p">))</span>
</span><span class='line'>      <span class="o">#</span><span class="p">(</span><span class="nb">&lt;= </span><span class="p">(</span><span class="nb">int </span><span class="sc">\A</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="sc">\Z</span><span class="p">)))</span>
</span><span class='line'>  <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">result</span>
</span><span class='line'>  <span class="p">[</span><span class="sc">\E</span> <span class="sc">\x</span> <span class="sc">\c</span> <span class="sc">\e</span> <span class="sc">\p</span> <span class="sc">\t</span> <span class="sc">\i</span> <span class="sc">\o</span> <span class="sc">\n</span> <span class="sc">\I</span> <span class="sc">\n</span> <span class="sc">\f</span> <span class="sc">\o</span> <span class="sc">\s</span><span class="nv">pace</span>
</span><span class='line'>   <span class="sc">\t</span> <span class="sc">\h</span> <span class="sc">\r</span> <span class="sc">\o</span> <span class="sc">\w</span> <span class="sc">\+</span> <span class="sc">\:</span> <span class="sc">\s</span><span class="nv">pace</span>
</span><span class='line'>   <span class="sc">\#</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">one-or-more</span> <span class="nv">exception-chars</span><span class="p">)</span> <span class="nv">?exception</span><span class="p">)</span>
</span><span class='line'>   <span class="o">&amp;</span> <span class="nv">_</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:throws</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">exception</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">?data</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:returns</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">data</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it &ndash; parsing done.</p>

<p>Now we just have to turn the results into unit tests. We have to be careful about comparing the results of the examples because they might contain closures, which look different every time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">replace-fun</span> <span class="p">[</span><span class="nv">unread-form</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">.replaceAll</span> <span class="nv">unread-form</span> <span class="s">&quot;#&lt;[^&gt;]*&gt;&quot;</span> <span class="s">&quot;#&lt;fun&gt;&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">prints-as</span> <span class="p">[</span><span class="nv">string</span> <span class="nv">form</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">replace-fun</span> <span class="nv">string</span><span class="p">)</span> <span class="p">(</span><span class="nf">replace-fun</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nb">pr </span><span class="nv">form</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the examples is a little tricky because some of them create bindings or classes that are used by later examples. We end up needing to eval the code at runtime.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">example-test</span> <span class="p">[</span><span class="nv">input</span> <span class="nv">prints</span> <span class="nv">result</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">match</span> <span class="nv">result</span>
</span><span class='line'>         <span class="p">[</span><span class="ss">:returns</span> <span class="nv">?value</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nf">prints-as</span> <span class="nv">value</span> <span class="p">(</span><span class="nf">input</span><span class="p">)))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="nv">prints</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nf">input</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'>         <span class="p">[</span><span class="ss">:throws</span> <span class="nv">?exception</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nf">try+</span> <span class="p">(</span><span class="nf">input</span><span class="p">)</span>
</span><span class='line'>                     <span class="nv">nil</span>
</span><span class='line'>                     <span class="p">(</span><span class="nf">catch</span> <span class="nv">java.lang.Object</span> <span class="nv">thrown</span>
</span><span class='line'>                       <span class="p">(</span><span class="nf">prints-as</span> <span class="nv">exception</span> <span class="p">(</span><span class="nb">class </span><span class="nv">thrown</span><span class="p">)))))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="nv">prints</span> <span class="p">(</span><span class="nf">with-out-str</span>
</span><span class='line'>                           <span class="p">(</span><span class="nf">try+</span> <span class="p">(</span><span class="nf">input</span><span class="p">)</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nf">catch</span> <span class="nv">java.lang.Object</span> <span class="nv">_</span> <span class="nv">nil</span><span class="p">))))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">insert-example-test</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">input</span> <span class="nv">prints</span> <span class="nv">result</span><span class="p">]}]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">example-test</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nb">eval </span><span class="o">&#39;</span><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;~</span><span class="ss">&#39;strucjure</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">read-string</span> <span class="nv">input</span><span class="p">))))</span> <span class="o">~</span><span class="nv">prints</span> <span class="o">&#39;~</span><span class="nv">result</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">insert-readme-test</span> <span class="p">[</span><span class="nv">file</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">do</span>
</span><span class='line'>     <span class="o">~@</span><span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">example</span> <span class="p">(</span><span class="nf">run</span> <span class="nv">readme</span> <span class="p">(</span><span class="nb">seq </span><span class="p">(</span><span class="nb">slurp </span><span class="p">(</span><span class="nb">eval </span><span class="nv">file</span><span class="p">))))]</span>
</span><span class='line'>         <span class="o">`</span><span class="p">(</span><span class="nf">insert-example-test</span> <span class="o">~</span><span class="nv">example</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">deftest</span> <span class="nv">readme-test</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insert-readme-test</span> <span class="s">&quot;README.md&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is fun. Not only does strucjure parse its own syntax, it reads its own documentation!</p>

<p>Parts of this were a little painful. The next version of strucjure will definitely have improved string matching. I&rsquo;m also looking at optimising/compiling views, as well as memoisation. Previous versions of strucjure supported both but were hard to maintain. For now I&rsquo;m going to be moving on to using strucjure to build other useful DSLs.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2012-10-25T19:37:00-07:00" pubdate data-updated="true">25 Oct 2012</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/clojure/'>clojure</a>, <a class='category' href='/blog/categories/strucjure/'>strucjure</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><div class="ps">I am often available for consulting work. Check out my <a href="/about.html">resume</a>.</div>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'scattered-thoughts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://scattered-thoughts.net/blog/2012/10/25/strucjure-reading-the-readme/';
        var disqus_url = 'http://scattered-thoughts.net/blog/2012/10/25/strucjure-reading-the-readme/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-18515092-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>