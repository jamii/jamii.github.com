
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Strucjure: reading the readme - Scattered Thoughts</title>
  <meta name="author" content="Jamie Brandon">

  
  <meta name="description" content="I just released strucjure, a clojure library and DSL for parsing and pattern matching based on Ometa. The readme on github has detailed descriptions &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://scattered-thoughts.net/blog/2012/10/25/strucjure-reading-the-readme">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/jamii" rel="subscribe-github" title="@jamii on GitHub" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
<ul class="subscribe">
  <li><a href="https://twitter.com/jamiiecb" rel="subscribe-twitter" title="@jamiiecb on Twitter" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 512 512"><path class="social" d="M0.001,334.932c33.327,30.816,118.891,59.981,188.517-8.271c-12.52,1.955-22.972-0.416-30.913-8.269
  c-7.531-7.465-7.945-15.182-3.914-22.202c3.275-5.725,10.184-9.741,16.977-13.934c-12.323,2.285-22.829,1.095-32.218-3.706
  c-12.604-6.444-24.863-13.228-28.3-27.207c7.71-8.112,16.28-15.359,34.831-12.627c-17.45-5.83-33.087-13.429-44.41-24.815
  c-11.028-11.091-12.163-18.302-13.932-26.996c9.632-3.567,19.688-5.421,30.478-4.353c-24.397-12.476-34.757-29.63-40.487-48.325
  c-1.731-5.652-2.044-11.03-1.31-16.545c98.826,37.305,145.11,64.109,170.662,89.251c11.496-30.589,38.3-99.868,78.371-123.646
  c0.191,3.77-1.309,7.837-4.357,12.189c11.863-6.609,21.125-17.188,37.445-16.98c-1.879,7.723-7.279,13.904-17.85,17.854
  c10.662-4.084,21.463-7.545,32.65-9.578c10.375-1.881,10.229,6.304,4.355,10.444c-11.916,8.412-24.578,9.456-37.006,13.498
  c38.105,0.949,69.266,18.994,93.604,58.343c8.088,13.074,13.52,26.149,14.807,40.487c16.254,4.563,32.426,5.494,48.76,2.61
  c4.475-0.796,8.645-1.63,12.627-3.482c-6.354,9.529-13.686,17.356-23.947,20.899c-9.811,3.387-19.637,6.688-30.473,6.968
  c17.641,6.675,37.082,7.045,57.033,5.659c-24.402,23.486-43.08,22.922-61.824,22.642c-8.221,34.703-25.025,69.315-60.52,101.005
  c-46.559,41.569-96.678,61.397-148.457,65.742c-48.552,4.07-95.488,3.512-146.726-20.464
  C56.486,393.349,24.648,368.884,0.001,334.932L0.001,334.932z"/></svg></a></li>
</ul>
  
  
  
  
  
<ul class="main-navigation">
  <li><a href="/"><h2>scattered thoughts</h2></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Strucjure: reading the readme</h1>
      
    
  </header>


<div class="entry-content"><p>I just released <a href="https://github.com/jamii/strucjure">strucjure</a>, a clojure library and DSL for parsing and pattern matching based on <a href="http://lambda-the-ultimate.org/node/2477">Ometa</a>.</p>

<p>The readme on github has detailed descriptions of the syntax etc which I won&rsquo;t repeat here. What I do want to do is run through a realistic example.</p>

<!--more-->


<p>The readme has a large number of examples and I want to be sure that these are all correct and up to date. As part of the test-suite for strucjure I parse the <a href="https://raw.github.com/jamii/strucjure/master/README.md">readme source</a>, pull out all the examples and make sure that they all run correctly and return the expected output.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>jamie@alien:~/strucjure<span class="nv">$ </span>lein <span class="nb">test </span>strucjure.test
</span><span class='line'>WARNING: newline already refers to: <span class="c">#&#39;clojure.core/newline in namespace: strucjure.test, being replaced by: #&#39;strucjure.test/newline</span>
</span><span class='line'>
</span><span class='line'>lein <span class="nb">test </span>strucjure.test
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 166 assertions.
</span><span class='line'>0 failures, 0 errors.
</span></code></pre></td></tr></table></div></figure>


<p>The readme parser is pretty simple. Since I control both the parser and the readme source so it doesn&rsquo;t need to be bullet-proof, just the simplest thing that will get the job done. Strucjure is very bare-bones at the moment though so we have to create a lot of simple views that really belong in a library somewhere.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">space</span>
</span><span class='line'>  <span class="sc">\s</span><span class="nv">pace</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">newline</span>
</span><span class='line'>  <span class="sc">\n</span><span class="nv">ewline</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">not-newline</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">not </span><span class="sc">\n</span><span class="nv">ewline</span><span class="p">)</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">line</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">not </span><span class="p">[])</span> <span class="c1">; have to consume at least one char</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">prefix</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">zero-or-more</span> <span class="nv">not-newline</span><span class="p">)</span> <span class="nv">?line</span><span class="p">)</span>
</span><span class='line'>               <span class="o">&amp;</span> <span class="p">((</span><span class="nf">optional</span> <span class="nv">newline</span><span class="p">)</span> <span class="nv">?end</span><span class="p">)))</span>
</span><span class='line'>  <span class="nv">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">indented-line</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prefix</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">one-or-more</span> <span class="nv">space</span><span class="p">)</span> <span class="nv">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nf">line</span> <span class="nv">?line</span><span class="p">))</span>
</span><span class='line'>  <span class="nv">line</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We want a tokeniser for various parts of the readme. We could write it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defnview</span> <span class="nv">tokenise</span> <span class="p">[</span><span class="nv">sep</span><span class="p">]</span>
</span><span class='line'>  <span class="c1">;; empty input</span>
</span><span class='line'>  <span class="p">[]</span> <span class="o">&#39;</span><span class="p">(())</span>
</span><span class='line'>  <span class="c1">;; throw away separator, start a new token</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="p">(</span><span class="nf">sep</span> <span class="nv">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">sep</span><span class="p">)</span> <span class="nv">?results</span><span class="p">)]</span> <span class="p">(</span><span class="nb">cons </span><span class="p">()</span> <span class="nv">results</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;; add the current char to the first token</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">?char</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">sep</span><span class="p">)</span> <span class="p">[</span><span class="nv">?result</span> <span class="o">&amp;</span> <span class="nv">?results</span><span class="p">])]</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">cons char </span><span class="nv">result</span><span class="p">)</span> <span class="nv">results</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately in the current implementation of strucjure that recursive call goes on the stack, so this view will blow up on large inputs. For now we just have to implement this view by hand to get access to recur.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">tokenise</span> <span class="p">[</span><span class="nv">sep</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">view/-&gt;Raw</span>
</span><span class='line'>   <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">input</span> <span class="nv">opts</span><span class="p">]</span>
</span><span class='line'>     <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">elems</span> <span class="p">(</span><span class="nb">seq </span><span class="nv">input</span><span class="p">)]</span>
</span><span class='line'>       <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">elems</span> <span class="nv">elems</span>
</span><span class='line'>              <span class="nv">token-acc</span> <span class="nv">nil</span>
</span><span class='line'>              <span class="nv">tokens-acc</span> <span class="nv">nil</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nb">if-let </span><span class="p">[[</span><span class="nv">remaining</span> <span class="nv">_</span><span class="p">]</span> <span class="p">(</span><span class="nf">view/run</span> <span class="nv">sep</span> <span class="nv">elems</span> <span class="nv">opts</span><span class="p">)]</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">recur</span> <span class="nv">remaining</span> <span class="nv">nil</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">reverse </span><span class="nv">token-acc</span><span class="p">)</span> <span class="nv">tokens-acc</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">if-let </span><span class="p">[[</span><span class="nv">elem</span> <span class="o">&amp;</span> <span class="nv">elems</span><span class="p">]</span> <span class="nv">elems</span><span class="p">]</span>
</span><span class='line'>             <span class="p">(</span><span class="nf">recur</span> <span class="nv">elems</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">elem</span> <span class="nv">token-acc</span><span class="p">)</span> <span class="nv">tokens-acc</span><span class="p">)</span>
</span><span class='line'>             <span class="p">[</span><span class="nv">nil</span> <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">reverse </span><span class="nv">token-acc</span><span class="p">)</span> <span class="nv">tokens-acc</span><span class="p">))])))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rest of the parser makes more sense reading in reverse order. We start by splitting up the readme by code delimiters (triple backticks). This gives us chunks of alternating text and code, so we parse every other chunk as a block of code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">code-delim</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prefix</span> <span class="sc">\`</span> <span class="sc">\`</span> <span class="sc">\`</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">:code-delim</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">readme</span>
</span><span class='line'>  <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">code-delim</span><span class="p">)</span> <span class="nv">?chunks</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">apply concat </span><span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">run</span> <span class="nv">code-block</span><span class="p">)</span> <span class="p">(</span><span class="nb">take-nth </span><span class="mi">2</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">chunks</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We only want to look at code blocks that are marked as clojure code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">code-block</span>
</span><span class='line'>  <span class="p">[</span><span class="sc">\c</span> <span class="sc">\l</span> <span class="sc">\o</span> <span class="sc">\j</span> <span class="sc">\u</span> <span class="sc">\r</span> <span class="sc">\e</span> <span class="sc">\n</span><span class="nv">ewline</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nf">code-block-inner</span> <span class="nv">?result</span><span class="p">)]</span>
</span><span class='line'>  <span class="nv">result</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few of the code blocks don&rsquo;t contain examples &ndash; we can detect these because they don&rsquo;t start with a &ldquo;user> &rdquo; prompt. All the other blocks contain a list of examples separated by prompts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">prompt</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">prefix</span> <span class="sc">\u</span> <span class="sc">\s</span> <span class="sc">\e</span> <span class="sc">\r</span> <span class="sc">\&gt;</span> <span class="sc">\s</span><span class="nv">pace</span><span class="p">)</span>
</span><span class='line'>  <span class="ss">:prompt</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">code-block-inner</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nf">prompt</span> <span class="nv">_</span><span class="p">)</span>
</span><span class='line'>       <span class="p">((</span><span class="nf">tokenise</span> <span class="nv">prompt</span><span class="p">)</span> <span class="nv">?chunks</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">run</span> <span class="nv">example</span><span class="p">)</span> <span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">%</span><span class="p">))</span> <span class="nv">chunks</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">_</span> <span class="c1">;; not a block of examples</span>
</span><span class='line'>  <span class="nv">nil</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>An example consists of an input, which may be on multiple lines, zero or more lines of printed output and finally a result.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">example</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="p">(</span><span class="nf">line</span> <span class="nv">?input-first</span><span class="p">)</span>
</span><span class='line'>   <span class="o">&amp;</span> <span class="p">((</span><span class="nf">zero-or-more-prefix</span> <span class="nv">indented-line</span><span class="p">)</span> <span class="nv">?input-rest</span><span class="p">)</span>
</span><span class='line'>   <span class="o">&amp;</span> <span class="p">((</span><span class="nf">one-or-more-prefix</span> <span class="nv">line</span><span class="p">)</span> <span class="nv">?output-lines</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:input</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">line</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">input-first</span> <span class="nv">input-rest</span><span class="p">)]</span> <span class="p">(</span><span class="nb">print </span><span class="p">(</span><span class="nb">apply str </span><span class="nv">line</span><span class="p">)</span> <span class="sc">\s</span><span class="nv">pace</span><span class="p">)))</span>
</span><span class='line'>   <span class="ss">:prints</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">line</span> <span class="p">(</span><span class="nb">butlast </span><span class="nv">output-lines</span><span class="p">)]</span> <span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nb">apply str </span><span class="nv">line</span><span class="p">))))</span>
</span><span class='line'>   <span class="ss">:result</span> <span class="p">(</span><span class="nf">run</span> <span class="nv">result</span> <span class="p">(</span><span class="nb">last </span><span class="nv">output-lines</span><span class="p">))})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is either a return value or an exception.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; #&quot;[a-zA-Z\.]&quot;</span>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">exception-chars</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">or </span><span class="sc">\.</span>
</span><span class='line'>      <span class="o">#</span><span class="p">(</span><span class="nb">&lt;= </span><span class="p">(</span><span class="nb">int </span><span class="sc">\a</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="sc">\z</span><span class="p">))</span>
</span><span class='line'>      <span class="o">#</span><span class="p">(</span><span class="nb">&lt;= </span><span class="p">(</span><span class="nb">int </span><span class="sc">\A</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nb">int </span><span class="sc">\Z</span><span class="p">)))</span>
</span><span class='line'>  <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defview</span> <span class="nv">result</span>
</span><span class='line'>  <span class="p">[</span><span class="sc">\E</span> <span class="sc">\x</span> <span class="sc">\c</span> <span class="sc">\e</span> <span class="sc">\p</span> <span class="sc">\t</span> <span class="sc">\i</span> <span class="sc">\o</span> <span class="sc">\n</span> <span class="sc">\I</span> <span class="sc">\n</span> <span class="sc">\f</span> <span class="sc">\o</span> <span class="sc">\s</span><span class="nv">pace</span>
</span><span class='line'>   <span class="sc">\t</span> <span class="sc">\h</span> <span class="sc">\r</span> <span class="sc">\o</span> <span class="sc">\w</span> <span class="sc">\+</span> <span class="sc">\:</span> <span class="sc">\s</span><span class="nv">pace</span>
</span><span class='line'>   <span class="sc">\#</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nf">one-or-more</span> <span class="nv">exception-chars</span><span class="p">)</span> <span class="nv">?exception</span><span class="p">)</span>
</span><span class='line'>   <span class="o">&amp;</span> <span class="nv">_</span><span class="p">]</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:throws</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">exception</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">?data</span>
</span><span class='line'>  <span class="p">[</span><span class="ss">:returns</span> <span class="p">(</span><span class="nb">apply str </span><span class="nv">data</span><span class="p">)])</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it &ndash; parsing done.</p>

<p>Now we just have to turn the results into unit tests. We have to be careful about comparing the results of the examples because they might contain closures, which look different every time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">replace-fun</span> <span class="p">[</span><span class="nv">unread-form</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">.replaceAll</span> <span class="nv">unread-form</span> <span class="s">&quot;#&lt;[^&gt;]*&gt;&quot;</span> <span class="s">&quot;#&lt;fun&gt;&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">prints-as</span> <span class="p">[</span><span class="nv">string</span> <span class="nv">form</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">replace-fun</span> <span class="nv">string</span><span class="p">)</span> <span class="p">(</span><span class="nf">replace-fun</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nb">pr </span><span class="nv">form</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the examples is a little tricky because some of them create bindings or classes that are used by later examples. We end up needing to eval the code at runtime.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">example-test</span> <span class="p">[</span><span class="nv">input</span> <span class="nv">prints</span> <span class="nv">result</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">match</span> <span class="nv">result</span>
</span><span class='line'>         <span class="p">[</span><span class="ss">:returns</span> <span class="nv">?value</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nf">prints-as</span> <span class="nv">value</span> <span class="p">(</span><span class="nf">input</span><span class="p">)))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="nv">prints</span> <span class="p">(</span><span class="nb">with-out-str </span><span class="p">(</span><span class="nf">input</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'>         <span class="p">[</span><span class="ss">:throws</span> <span class="nv">?exception</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nf">try+</span> <span class="p">(</span><span class="nf">input</span><span class="p">)</span>
</span><span class='line'>                     <span class="nv">nil</span>
</span><span class='line'>                     <span class="p">(</span><span class="nf">catch</span> <span class="nv">java.lang.Object</span> <span class="nv">thrown</span>
</span><span class='line'>                       <span class="p">(</span><span class="nf">prints-as</span> <span class="nv">exception</span> <span class="p">(</span><span class="nb">class </span><span class="nv">thrown</span><span class="p">)))))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="nv">prints</span> <span class="p">(</span><span class="nf">with-out-str</span>
</span><span class='line'>                           <span class="p">(</span><span class="nf">try+</span> <span class="p">(</span><span class="nf">input</span><span class="p">)</span>
</span><span class='line'>                                 <span class="p">(</span><span class="nf">catch</span> <span class="nv">java.lang.Object</span> <span class="nv">_</span> <span class="nv">nil</span><span class="p">))))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">insert-example-test</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">input</span> <span class="nv">prints</span> <span class="nv">result</span><span class="p">]}]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">example-test</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nb">eval </span><span class="o">&#39;</span><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;~</span><span class="ss">&#39;strucjure</span><span class="p">)</span> <span class="o">~</span><span class="p">(</span><span class="nf">read-string</span> <span class="nv">input</span><span class="p">))))</span> <span class="o">~</span><span class="nv">prints</span> <span class="o">&#39;~</span><span class="nv">result</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">insert-readme-test</span> <span class="p">[</span><span class="nv">file</span><span class="p">]</span>
</span><span class='line'>  <span class="o">`</span><span class="p">(</span><span class="nf">do</span>
</span><span class='line'>     <span class="o">~@</span><span class="p">(</span><span class="nb">for </span><span class="p">[</span><span class="nv">example</span> <span class="p">(</span><span class="nf">run</span> <span class="nv">readme</span> <span class="p">(</span><span class="nb">seq </span><span class="p">(</span><span class="nb">slurp </span><span class="p">(</span><span class="nb">eval </span><span class="nv">file</span><span class="p">))))]</span>
</span><span class='line'>         <span class="o">`</span><span class="p">(</span><span class="nf">insert-example-test</span> <span class="o">~</span><span class="nv">example</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">deftest</span> <span class="nv">readme-test</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">insert-readme-test</span> <span class="s">&quot;README.md&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is fun. Not only does strucjure parse its own syntax, it reads its own documentation!</p>

<p>Parts of this were a little painful. The next version of strucjure will definitely have improved string matching. I&rsquo;m also looking at optimising/compiling views, as well as memoisation. Previous versions of strucjure supported both but were hard to maintain. For now I&rsquo;m going to be moving on to using strucjure to build other useful DSLs.</p>
</div>


</article>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jamie Brandon
</p>

</footer>
  
</body>
</html>
