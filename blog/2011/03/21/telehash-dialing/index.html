
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Telehash: dialing - Scattered Thoughts</title>
  <meta name="author" content="Jamie Brandon">

  
  <meta name="description" content="The next step in building a telehash switch is being able to dial. First a disclaimer: this post reflects my current understanding of TeleHash and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://scattered-thoughts.net/blog/2011/03/21/telehash-dialing">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-18515092-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/jamii" rel="subscribe-github" title="@jamii on GitHub" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
<ul class="subscribe">
  <li><a href="https://twitter.com/jamiiecb" rel="subscribe-twitter" title="@jamiiecb on Twitter" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 512 512"><path class="social" d="M0.001,334.932c33.327,30.816,118.891,59.981,188.517-8.271c-12.52,1.955-22.972-0.416-30.913-8.269
  c-7.531-7.465-7.945-15.182-3.914-22.202c3.275-5.725,10.184-9.741,16.977-13.934c-12.323,2.285-22.829,1.095-32.218-3.706
  c-12.604-6.444-24.863-13.228-28.3-27.207c7.71-8.112,16.28-15.359,34.831-12.627c-17.45-5.83-33.087-13.429-44.41-24.815
  c-11.028-11.091-12.163-18.302-13.932-26.996c9.632-3.567,19.688-5.421,30.478-4.353c-24.397-12.476-34.757-29.63-40.487-48.325
  c-1.731-5.652-2.044-11.03-1.31-16.545c98.826,37.305,145.11,64.109,170.662,89.251c11.496-30.589,38.3-99.868,78.371-123.646
  c0.191,3.77-1.309,7.837-4.357,12.189c11.863-6.609,21.125-17.188,37.445-16.98c-1.879,7.723-7.279,13.904-17.85,17.854
  c10.662-4.084,21.463-7.545,32.65-9.578c10.375-1.881,10.229,6.304,4.355,10.444c-11.916,8.412-24.578,9.456-37.006,13.498
  c38.105,0.949,69.266,18.994,93.604,58.343c8.088,13.074,13.52,26.149,14.807,40.487c16.254,4.563,32.426,5.494,48.76,2.61
  c4.475-0.796,8.645-1.63,12.627-3.482c-6.354,9.529-13.686,17.356-23.947,20.899c-9.811,3.387-19.637,6.688-30.473,6.968
  c17.641,6.675,37.082,7.045,57.033,5.659c-24.402,23.486-43.08,22.922-61.824,22.642c-8.221,34.703-25.025,69.315-60.52,101.005
  c-46.559,41.569-96.678,61.397-148.457,65.742c-48.552,4.07-95.488,3.512-146.726-20.464
  C56.486,393.349,24.648,368.884,0.001,334.932L0.001,334.932z"/></svg></a></li>
</ul>
  
  
  
  
  
<ul class="main-navigation">
  <li><a href="/"><h2>scattered thoughts</h2></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Telehash: dialing</h1>
      
    
  </header>


<div class="entry-content"><p>The next step in building a telehash switch is being able to dial.</p>

<!--more-->


<p>First a disclaimer: this post reflects my current understanding of TeleHash and Kademlia and is highly likely to be wrong. This code has only received minimal testing. Properly testing a p2p network is not something I&rsquo;m entirely sure how to do yet. Expect to see more on that in later posts.</p>

<p>Each TeleHash node and each key in the DHT is identified by a 160 bit sha1 hash (aka end). In the original Kademlia paper the node ids are selected at random but in TeleHash they are the hashed address (IP:port) of the node. This means that malicious nodes don&rsquo;t get to choose where they are inserted in the DHT.</p>

<p>Kademlia routing is based on the XOR distance between ends. This forms a metric space over the set of ends.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">distance</span><span class="p">(</span><span class="nv">A</span><span class="p">,</span> <span class="nv">B</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="nv">EndA</span><span class="p">}</span> <span class="o">=</span> <span class="n">to_end</span><span class="p">(</span><span class="nv">A</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="nv">EndB</span><span class="p">}</span> <span class="o">=</span> <span class="n">to_end</span><span class="p">(</span><span class="nv">B</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Bytes</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="n">zip</span><span class="p">(</span><span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">EndA</span><span class="p">),</span> <span class="nb">binary_to_list</span><span class="p">(</span><span class="nv">EndB</span><span class="p">)),</span>
</span><span class='line'>    <span class="nv">Xor</span> <span class="o">=</span> <span class="nb">list_to_binary</span><span class="p">([</span><span class="nv">ByteA</span> <span class="ow">bxor</span> <span class="nv">ByteB</span> <span class="p">||</span> <span class="p">{</span><span class="nv">ByteA</span><span class="p">,</span> <span class="nv">ByteB</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bytes</span><span class="p">]),</span>
</span><span class='line'>    <span class="o">&lt;&lt;</span><span class="nv">Dist</span><span class="p">:</span><span class="o">?</span><span class="nv">END_BITS</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nv">Xor</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Dist</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Kademlia paper defines two constants, K and A. K controls the amount of redundant storage in the DHT and A controls the number of parallel requests issued by each node. To insert a key into the DHT a node must be able to locate the K nodes whose IDs are closest to the key. This process is called dialing.</p>

<p>Dialing works roughly as follows. Each node keeps track of all the other nodes it has seen. Upon receiving a +end signal a node will reply with a .see command containing the K nodes it is aware of which are closest to the specified end. To dial an end we send a +end signal to each of the K closest nodes we are aware of. Then to each node contained in the .see replies we send +end signals, and so on until we run out of nodes to contact.</p>

<p>Now this is nice and simple and will work but it generates a huge amount of load on the network. To reduce this Kademlia introduces two additional rules. First, we only send up to A signals at a time and don&rsquo;t send any new signals until previous signals have either generated a reply or timed out. Second, we finish early if at any point we have received replies from K nodes which are closer to the end than all the nodes we are waiting to contact. The Kademlia paper proves that under reasonable assumptions about the knowledge of each node this still has a very high chance to return the correct results.</p>

<p>The dialer process is an event handler which has two important data structures. The first stores the dialer configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">conf</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">target</span><span class="p">,</span> <span class="c">% the end to dial</span>
</span><span class='line'>          <span class="n">timeout</span><span class="p">,</span> <span class="c">% the timeout for the entire dialing process</span>
</span><span class='line'>          <span class="n">ref</span><span class="p">,</span> <span class="n">caller</span> <span class="c">% reply details</span>
</span><span class='line'>         <span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The second record stores the state of the dialing process. The principle around which the dialer is designed is that the state record is a reflection of the outside world and the sole job of the dialer is to keep this record up to date while maintaining the invariants in the comments. This is often the way that I write code and I feel that it needs it&rsquo;s own post once I can articulate it properly. It&rsquo;s certainly heavily informed both by the designs in <a href="http://books.google.co.uk/books?id=SxPzSTcTalAC&amp;printsec=frontcover&amp;dq=okasaki+purely+functional&amp;hl=en&amp;ei=6GiHTdTcKY_RcfjR_ZkD&amp;sa=X&amp;oi=book_result&amp;ct=result&amp;resnum=1&amp;ved=0CC4Q6AEwAA#v=onepage&amp;q&amp;f=false">Okasaki&rsquo;s Purely Functional Data Structures</a> and by Conal Elliott&rsquo;s ideas about <a href="http://conal.net/blog/posts/denotational-design-with-type-class-morphisms/">denotational semantics and type class morphisms</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">state</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">fresh</span><span class="p">,</span> <span class="c">% nodes which have not yet been contacted</span>
</span><span class='line'>          <span class="n">pinged</span><span class="p">,</span> <span class="c">% nodes which have been contacted and have not replied</span>
</span><span class='line'>          <span class="n">waiting</span><span class="p">,</span> <span class="c">% nodes in pinged which were contacted less than ?DIAL_TIMEOUT ago</span>
</span><span class='line'>          <span class="n">ponged</span><span class="p">,</span> <span class="c">% nodes which have been contacted and have replied</span>
</span><span class='line'>          <span class="n">seen</span> <span class="c">% all nodes which have been seen</span>
</span><span class='line'>         <span class="p">}).</span> <span class="c">% invariant: pq:length(waiting) = ?A or pq:empty(fresh)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The dialer module exports the dial function which creates the records and starts the event handler.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">dial</span><span class="p">(</span><span class="nv">To</span><span class="p">,</span> <span class="nv">From</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">dialing</span><span class="p">,</span> <span class="nv">To</span><span class="p">,</span> <span class="nv">From</span><span class="p">,</span> <span class="nv">Timeout</span><span class="p">]),</span>
</span><span class='line'>    <span class="nv">Ref</span> <span class="o">=</span> <span class="nn">erlang</span><span class="p">:</span><span class="n">make_ref</span><span class="p">(),</span>
</span><span class='line'>    <span class="nv">Target</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="n">to_end</span><span class="p">(</span><span class="nv">To</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Conf</span> <span class="o">=</span> <span class="nl">#conf</span><span class="p">{</span>
</span><span class='line'>      <span class="n">target</span> <span class="o">=</span> <span class="nv">Target</span><span class="p">,</span>
</span><span class='line'>      <span class="n">timeout</span> <span class="o">=</span> <span class="nv">Timeout</span><span class="p">,</span>
</span><span class='line'>      <span class="n">ref</span> <span class="o">=</span> <span class="nv">Ref</span><span class="p">,</span>
</span><span class='line'>      <span class="n">caller</span> <span class="o">=</span> <span class="n">self</span><span class="p">()</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>    <span class="nv">Nodes</span> <span class="o">=</span> <span class="p">[{</span><span class="nn">util</span><span class="p">:</span><span class="n">distance</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Target</span><span class="p">),</span> <span class="nv">Address</span><span class="p">}</span>
</span><span class='line'>             <span class="p">||</span> <span class="nv">Address</span> <span class="o">&lt;-</span> <span class="nv">From</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">State</span> <span class="o">=</span> <span class="nl">#state</span><span class="p">{</span>
</span><span class='line'>      <span class="n">fresh</span><span class="o">=</span><span class="nn">pq</span><span class="p">:</span><span class="n">from_list</span><span class="p">(</span><span class="nv">Nodes</span><span class="p">),</span>
</span><span class='line'>      <span class="n">pinged</span><span class="o">=</span><span class="nn">sets</span><span class="p">:</span><span class="n">new</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">waiting</span><span class="o">=</span><span class="nn">pq</span><span class="p">:</span><span class="n">empty</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">ponged</span><span class="o">=</span><span class="nn">pq</span><span class="p">:</span><span class="n">empty</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">seen</span><span class="o">=</span><span class="nn">sets</span><span class="p">:</span><span class="n">new</span><span class="p">()</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>    <span class="n">ok</span> <span class="o">=</span> <span class="nn">switch</span><span class="p">:</span><span class="n">add_handler</span><span class="p">(</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">}),</span>
</span><span class='line'>    <span class="nv">Ref</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The aim is to handle events and maintain the state invariants until we are finished. How do we define finished?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% is the dialing finished yet?</span>
</span><span class='line'><span class="nf">finished</span><span class="p">(</span><span class="nl">#state</span><span class="p">{</span><span class="n">fresh</span><span class="o">=</span><span class="nv">Fresh</span><span class="p">,</span> <span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting</span><span class="p">,</span> <span class="n">ponged</span><span class="o">=</span><span class="nv">Ponged</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">(</span><span class="nn">pq</span><span class="p">:</span><span class="n">is_empty</span><span class="p">(</span><span class="nv">Fresh</span><span class="p">)</span> <span class="ow">and</span> <span class="nn">pq</span><span class="p">:</span><span class="n">is_empty</span><span class="p">(</span><span class="nv">Waiting</span><span class="p">))</span> <span class="c">% no way to continue</span>
</span><span class='line'>    <span class="ow">or</span>
</span><span class='line'>    <span class="p">(</span><span class="k">case</span> <span class="nn">pq</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="nv">Ponged</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="o">?</span><span class="nv">K</span> <span class="k">of</span>
</span><span class='line'>         <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>             <span class="n">false</span><span class="p">;</span> <span class="c">% dont yet have K nodes</span>
</span><span class='line'>         <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>             <span class="c">% finish if the K closest nodes we know are closer than all the nodes we haven&#39;t checked yet</span>
</span><span class='line'>             <span class="p">{</span><span class="nv">Dist_fresh</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">peek</span><span class="p">(</span><span class="nv">Fresh</span><span class="p">),</span>
</span><span class='line'>             <span class="p">{</span><span class="nv">Dist_waiting</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">peek</span><span class="p">(</span><span class="nv">Waiting</span><span class="p">),</span>
</span><span class='line'>             <span class="p">{</span><span class="nv">Nodes</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">pop</span><span class="p">(</span><span class="nv">Ponged</span><span class="p">,</span> <span class="o">?</span><span class="nv">K</span><span class="p">),</span>
</span><span class='line'>             <span class="p">{</span><span class="nv">Dist_ponged</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="n">last</span><span class="p">(</span><span class="nv">Nodes</span><span class="p">),</span>
</span><span class='line'>             <span class="p">(</span><span class="nv">Dist_ponged</span> <span class="o">&lt;</span> <span class="nv">Dist_fresh</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nv">Dist_ponged</span> <span class="o">&lt;</span> <span class="nv">Dist_waiting</span><span class="p">)</span>
</span><span class='line'>     <span class="k">end</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the invariants we aim to maintain is that either the fresh queue is empty or the length of the waiting queue is A. This ensures that we send out +end signals whenever possible. This invariant is maintained by calling the ping_nodes function after every event.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% contact nodes from fresh until the waiting list is full</span>
</span><span class='line'><span class="nf">ping_nodes</span><span class="p">(</span><span class="nl">#conf</span><span class="p">{</span><span class="n">target</span><span class="o">=</span><span class="nv">Target</span><span class="p">},</span> <span class="nl">#state</span><span class="p">{</span><span class="n">fresh</span><span class="o">=</span><span class="nv">Fresh</span><span class="p">,</span> <span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting</span><span class="p">,</span> <span class="n">pinged</span><span class="o">=</span><span class="nv">Pinged</span><span class="p">}</span><span class="o">=</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Num</span> <span class="o">=</span> <span class="o">?</span><span class="nv">A</span> <span class="o">-</span> <span class="nn">pq</span><span class="p">:</span><span class="nb">length</span><span class="p">(</span><span class="nv">Waiting</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Nodes</span><span class="p">,</span> <span class="nv">Fresh2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">pop</span><span class="p">(</span><span class="nv">Fresh</span><span class="p">,</span> <span class="nv">Num</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Telex</span> <span class="o">=</span> <span class="p">{</span><span class="n">struct</span><span class="p">,</span> <span class="p">[{</span><span class="n">&#39;+end&#39;</span><span class="p">,</span> <span class="nn">util</span><span class="p">:</span><span class="n">end_to_hex</span><span class="p">(</span><span class="nv">Target</span><span class="p">)}]},</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="n">foreach</span><span class="p">(</span>
</span><span class='line'>      <span class="k">fun</span> <span class="p">({</span><span class="nv">Dist</span><span class="p">,</span> <span class="nv">Address</span><span class="p">}</span><span class="o">=</span><span class="nv">Node</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>              <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">ping</span><span class="p">,</span> <span class="nv">Dist</span><span class="p">,</span> <span class="nv">Address</span><span class="p">]),</span>
</span><span class='line'>              <span class="nn">switch</span><span class="p">:</span><span class="nb">send</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Telex</span><span class="p">),</span>
</span><span class='line'>              <span class="nn">erlang</span><span class="p">:</span><span class="nb">send_after</span><span class="p">(</span><span class="o">?</span><span class="nv">DIAL_TIMEOUT</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="p">{</span><span class="n">timeout</span><span class="p">,</span> <span class="nv">Node</span><span class="p">})</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>      <span class="nv">Nodes</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Waiting2</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">push</span><span class="p">(</span><span class="nv">Nodes</span><span class="p">,</span> <span class="nv">Waiting</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Pinged2</span> <span class="o">=</span> <span class="nn">sets</span><span class="p">:</span><span class="n">union</span><span class="p">(</span><span class="nv">Pinged</span><span class="p">,</span> <span class="nn">sets</span><span class="p">:</span><span class="n">from_list</span><span class="p">(</span><span class="nv">Nodes</span><span class="p">)),</span>
</span><span class='line'>    <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">fresh</span><span class="o">=</span><span class="nv">Fresh2</span><span class="p">,</span> <span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting2</span><span class="p">,</span> <span class="n">pinged</span><span class="o">=</span><span class="nv">Pinged2</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>We handle replies by moving the replying node from the waiting queue to the ponged queue and inserting the .see nodes into the fresh list. We cannot allow duplicate nodes so the seen set is kept up to date. The pinged set will be used later to ensure that we only accept replies from nodes we have already contacted and only accept one reply per node.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% handle a reply from a node</span>
</span><span class='line'><span class="nf">ponged</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">See</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">fresh</span><span class="o">=</span><span class="nv">Fresh</span><span class="p">,</span> <span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting</span><span class="p">,</span> <span class="n">pinged</span><span class="o">=</span><span class="nv">Pinged</span><span class="p">,</span> <span class="n">ponged</span><span class="o">=</span><span class="nv">Ponged</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="nv">Seen</span><span class="p">}</span><span class="o">=</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Waiting2</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Waiting</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Pinged2</span> <span class="o">=</span> <span class="nn">sets</span><span class="p">:</span><span class="n">del_element</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Pinged</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Ponged2</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">push_one</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Ponged</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">New_nodes</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="n">filter</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">See_node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="ow">not</span><span class="p">(</span><span class="nn">sets</span><span class="p">:</span><span class="n">is_element</span><span class="p">(</span><span class="nv">See_node</span><span class="p">,</span> <span class="nv">Seen</span><span class="p">))</span> <span class="k">end</span><span class="p">,</span> <span class="nv">See</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Fresh2</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">push</span><span class="p">(</span><span class="nv">New_nodes</span><span class="p">,</span> <span class="nv">Fresh</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Seen2</span> <span class="o">=</span> <span class="nn">sets</span><span class="p">:</span><span class="n">union</span><span class="p">(</span><span class="nv">Seen</span><span class="p">,</span> <span class="nn">sets</span><span class="p">:</span><span class="n">from_list</span><span class="p">(</span><span class="nv">See</span><span class="p">)),</span>
</span><span class='line'>    <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">fresh</span><span class="o">=</span><span class="nv">Fresh2</span><span class="p">,</span> <span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting2</span><span class="p">,</span> <span class="n">pinged</span><span class="o">=</span><span class="nv">Pinged2</span><span class="p">,</span> <span class="n">ponged</span><span class="o">=</span><span class="nv">Ponged2</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="nv">Seen2</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once we are finished we need to return the results to the caller.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% return results to the caller</span>
</span><span class='line'><span class="nf">return</span><span class="p">(</span><span class="nl">#conf</span><span class="p">{</span><span class="n">ref</span><span class="o">=</span><span class="nv">Ref</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="nv">Caller</span><span class="p">},</span> <span class="nl">#state</span><span class="p">{</span><span class="n">ponged</span><span class="o">=</span><span class="nv">Ponged</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Nodes</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">pq</span><span class="p">:</span><span class="n">pop</span><span class="p">(</span><span class="nv">Ponged</span><span class="p">,</span> <span class="o">?</span><span class="nv">K</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">returning</span><span class="p">,</span> <span class="nv">Nodes</span><span class="p">]),</span>
</span><span class='line'>    <span class="nv">Result</span> <span class="o">=</span> <span class="p">[</span><span class="nv">Address</span> <span class="p">||</span> <span class="p">{_</span><span class="nv">Dist</span><span class="p">,</span> <span class="nv">Address</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Nodes</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">Caller</span> <span class="o">!</span> <span class="p">{</span><span class="n">dialed</span><span class="p">,</span> <span class="nv">Ref</span><span class="p">,</span> <span class="nv">Result</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, after each event we call continue to decide whether to finish and return results or to carry on sending signals.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% either continue to dial or return results</span>
</span><span class='line'><span class="c">% meant for use at the end of a gen_event callback</span>
</span><span class='line'><span class="nf">continue</span><span class="p">(</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">finished</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="n">return</span><span class="p">(</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
</span><span class='line'>            <span class="n">remove_handler</span><span class="p">;</span>
</span><span class='line'>        <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">State2</span> <span class="o">=</span> <span class="n">ping_nodes</span><span class="p">(</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
</span><span class='line'>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State2</span><span class="p">}}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The functions above are glued together by a gen_event handler. The handler is attached to the switch gen_event manager and receives an event for each telex arriving at the switch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">behaviour</span><span class="p">(</span><span class="n">gen_event</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">init</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">handle_event</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_call</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">handle_info</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">terminate</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">code_change</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The init function is called when the handler is started. It sends out the first +end signals and sets a timer that tells the handler when to give up dialling.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">init</span><span class="p">({</span><span class="nl">#conf</span><span class="p">{</span><span class="n">timeout</span><span class="o">=</span><span class="nv">Timeout</span><span class="p">}</span><span class="o">=</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">erlang</span><span class="p">:</span><span class="nb">send_after</span><span class="p">(</span><span class="nv">Timeout</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="n">giveup</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">State2</span> <span class="o">=</span> <span class="n">ping_nodes</span><span class="p">(</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
</span><span class='line'>    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State2</span><span class="p">}}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The giveup timeout is simple to deal with.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">handle_info</span><span class="p">(</span><span class="n">giveup</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">giveup</span><span class="p">,</span> <span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">]),</span>
</span><span class='line'>    <span class="n">remove_handler</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As are the timeouts from individual signals.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">handle_info</span><span class="p">({</span><span class="n">timeout</span><span class="p">,</span> <span class="nv">Node</span><span class="p">},</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">waiting</span><span class="o">=</span><span class="nv">Waiting</span><span class="p">}</span><span class="o">=</span><span class="nv">State</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="nv">Node</span><span class="p">]),</span>
</span><span class='line'>    <span class="nv">State2</span> <span class="o">=</span> <span class="nv">State</span><span class="nl">#state</span><span class="p">{</span><span class="n">waiting</span><span class="o">=</span><span class="nn">pq</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Waiting</span><span class="p">)},</span>
</span><span class='line'>    <span class="n">continue</span><span class="p">(</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State2</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last callback is the messiest. This essentially just calls ponged and continue, but first has to sanity check the incoming message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">handle_event</span><span class="p">({</span><span class="n">recv</span><span class="p">,</span> <span class="nv">Address</span><span class="p">,</span> <span class="nv">Telex</span><span class="p">},</span> <span class="p">{</span><span class="nl">#conf</span><span class="p">{</span><span class="n">target</span><span class="o">=</span><span class="nv">Target</span><span class="p">}</span><span class="o">=</span><span class="nv">Conf</span><span class="p">,</span> <span class="nl">#state</span><span class="p">{</span><span class="n">pinged</span><span class="o">=</span><span class="nv">Pinged</span><span class="p">}</span><span class="o">=</span><span class="nv">State</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">telex</span><span class="p">:</span><span class="nb">get</span><span class="p">(</span><span class="nv">Telex</span><span class="p">,</span> <span class="n">&#39;.see&#39;</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="n">not_found</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">}};</span>
</span><span class='line'>        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Address_binaries</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>            <span class="nv">Dist</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="n">distance</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Target</span><span class="p">),</span>
</span><span class='line'>            <span class="nv">Node</span> <span class="o">=</span> <span class="p">{</span><span class="nv">Dist</span><span class="p">,</span> <span class="nv">Address</span><span class="p">},</span>
</span><span class='line'>            <span class="k">case</span> <span class="nn">sets</span><span class="p">:</span><span class="n">is_element</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Pinged</span><span class="p">)</span> <span class="k">of</span> <span class="c">% !!! command ids would make a better check</span>
</span><span class='line'>                <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">}};</span>
</span><span class='line'>                <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>                    <span class="k">try</span> <span class="p">[{</span><span class="nn">util</span><span class="p">:</span><span class="n">distance</span><span class="p">(</span><span class="nv">Target</span><span class="p">,</span> <span class="nv">Bin</span><span class="p">),</span> <span class="nn">util</span><span class="p">:</span><span class="n">binary_to_address</span><span class="p">(</span><span class="nv">Bin</span><span class="p">)}</span> <span class="p">||</span> <span class="nv">Bin</span> <span class="o">&lt;-</span> <span class="nv">Address_binaries</span><span class="p">]</span> <span class="k">of</span>
</span><span class='line'>                        <span class="nv">Nodes</span> <span class="o">-&gt;</span>
</span><span class='line'>                            <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">pong</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">Nodes</span><span class="p">]),</span>
</span><span class='line'>                            <span class="nv">State2</span> <span class="o">=</span> <span class="n">ponged</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Nodes</span><span class="p">,</span> <span class="nv">State</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">continue</span><span class="p">(</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State2</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">catch</span>
</span><span class='line'>                        <span class="p">_:</span><span class="nv">Error</span> <span class="o">-&gt;</span>
</span><span class='line'>                            <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">bad_see</span><span class="p">,</span> <span class="nv">Address</span><span class="p">,</span> <span class="nv">Telex</span><span class="p">,</span> <span class="nv">Error</span><span class="p">,</span> <span class="nn">erlang</span><span class="p">:</span><span class="n">get_stacktrace</span><span class="p">()]),</span>
</span><span class='line'>                            <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{</span><span class="nv">Conf</span><span class="p">,</span> <span class="nv">State</span><span class="p">}}</span>
</span><span class='line'>                    <span class="k">end</span>
</span><span class='line'>            <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s pretty much it &ndash; we now (probably) have a working dialer. I spent a fair few hours teasing this apart but hopefully the end result is fairly simple to understand. The full code is in the <a href="http://github.com/jamii/erl-telehash">repo</a> as always.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="mi">4</span><span class="o">&gt;</span> <span class="nn">switch</span><span class="p">:</span><span class="n">start_link</span><span class="p">().</span>
</span><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">}</span>
</span><span class='line'><span class="mi">5</span><span class="o">&gt;</span> <span class="nv">Root</span> <span class="o">=</span> <span class="p">{</span><span class="n">address</span><span class="p">,</span> <span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span> <span class="mi">42424</span><span class="p">}.</span>
</span><span class='line'><span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'><span class="mi">6</span><span class="o">&gt;</span> <span class="nn">dialer</span><span class="p">:</span><span class="n">dial_sync</span><span class="p">(</span><span class="nv">Root</span><span class="p">,</span> <span class="p">[</span><span class="nv">Root</span><span class="p">],</span> <span class="mi">10000</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">06</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">35</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">dialing</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="p">[{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}]</span>
</span><span class='line'>    <span class="mi">10000</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">06</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">ping</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">06</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">switch_event</span>
</span><span class='line'>    <span class="nb">send</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="nn">struct</span><span class="p">:</span> <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_to&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;208.68.163.247:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">&#39;+end&#39;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;38666817e1b38470644e004b9356c1622368fa57&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">switch_event</span>
</span><span class='line'>    <span class="n">recv</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="nn">struct</span><span class="p">:</span> <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_ring&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">18115</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;.see&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;204.232.205.180:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;208.68.163.247:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">]},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_br&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">240</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_to&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;203.218.138.245:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">pong</span>
</span><span class='line'>    <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="p">[{</span><span class="mi">535375931004298447338698443374311161987273280591</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}},</span>
</span><span class='line'>     <span class="p">{</span><span class="mi">0</span><span class="p">,{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">ping</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">ping</span>
</span><span class='line'>    <span class="mi">535375931004298447338698443374311161987273280591</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">switch_event</span>
</span><span class='line'>    <span class="nb">send</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="nn">struct</span><span class="p">:</span> <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_to&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;208.68.163.247:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">&#39;+end&#39;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;38666817e1b38470644e004b9356c1622368fa57&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">switch_event</span>
</span><span class='line'>    <span class="nb">send</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="nn">struct</span><span class="p">:</span> <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_to&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;204.232.205.180:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="n">&#39;+end&#39;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;38666817e1b38470644e004b9356c1622368fa57&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">switch_event</span>
</span><span class='line'>    <span class="n">recv</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="nn">struct</span><span class="p">:</span> <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_ring&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">16506</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;.see&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;204.232.205.180:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;208.68.163.247:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">]},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_br&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">162</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_to&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;203.218.138.245:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">pong</span>
</span><span class='line'>    <span class="mi">535375931004298447338698443374311161987273280591</span><span class="p">:</span> <span class="p">{</span><span class="n">address</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="p">[{</span><span class="mi">535375931004298447338698443374311161987273280591</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}},</span>
</span><span class='line'>     <span class="p">{</span><span class="mi">0</span><span class="p">,{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">80</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">switch_event</span>
</span><span class='line'>    <span class="n">recv</span>
</span><span class='line'>    <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="nn">struct</span><span class="p">:</span> <span class="p">[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_ring&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">18115</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;.see&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">[</span><span class="o">&lt;&lt;</span><span class="s">&quot;204.232.205.180:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;208.68.163.247:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">]},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_br&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="mi">320</span><span class="p">},</span>
</span><span class='line'>             <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;_to&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="o">&lt;&lt;</span><span class="s">&quot;203.218.138.245:42424&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">pong</span>
</span><span class='line'>    <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}</span>
</span><span class='line'>    <span class="p">[{</span><span class="mi">535375931004298447338698443374311161987273280591</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}},</span>
</span><span class='line'>     <span class="p">{</span><span class="mi">0</span><span class="p">,{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}}]</span>
</span><span class='line'>
</span><span class='line'><span class="o">=</span><span class="nv">INFO</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">21</span><span class="o">-</span><span class="nv">Mar</span><span class="o">-</span><span class="mi">2011</span><span class="p">::</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">07</span> <span class="o">===</span>
</span><span class='line'>    <span class="nn">pid</span><span class="p">:</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">79</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">dialer</span>
</span><span class='line'>    <span class="n">returning</span>
</span><span class='line'>    <span class="p">[{</span><span class="mi">0</span><span class="p">,{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}},</span>
</span><span class='line'>     <span class="p">{</span><span class="mi">535375931004298447338698443374311161987273280591</span><span class="p">,</span>
</span><span class='line'>      <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}}]</span>
</span><span class='line'><span class="p">{</span><span class="n">ok</span><span class="p">,[{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;208.68.163.247&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">},</span>
</span><span class='line'>     <span class="p">{</span><span class="n">address</span><span class="p">,</span><span class="s">&quot;204.232.205.180&quot;</span><span class="p">,</span><span class="mi">42424</span><span class="p">}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One last note: after I finished writing this I started thinking about what would happen if I run more than one dialer in parallel. Unlike Kademlia, TeleHash does not currently use command IDs so the dialer cannot tell if the response came in reply to its own command or in reply to the command of another dialer on the same node. It&rsquo;s the kind of bug that would be very rare in actual use but might be carefully exploited by a malicious node. Finding these kinds of bugs is going to be really hard.</p>
</div>


  <footer>
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/03/17/telehash-basics/" title="Previous Post: Telehash: basics">&laquo; Telehash: basics</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/03/23/telehash-bittrees/" title="Next Post: Telehash: bit_trees">Telehash: bit_trees &raquo;</a>
      
    </p>
  </footer>
</article>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jamie Brandon
</p>

</footer>
  











</body>
</html>
