
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Telehash: buckets - Scattered Thoughts</title>
	<meta name="author" content="Jamie Brandon">

	
	<meta name="description" content="The other half of the routing table is the buckets which store node addresses. Usual disclaimer: none of this is properly tested yet. The Kademlia &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Scattered Thoughts</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:scattered-thoughts.net">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="email" href="mailto:jamie@scattered-thoughts.net" title="Email">Email</a>
		
		
		
		
		
		<a class="github" href="https://github.com/jamii" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:scattered-thoughts.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Telehash: buckets</h1>
	<div class="entry-content"><p>The other half of the routing table is the buckets which store node addresses.</p>

<!--more-->


<p>Usual disclaimer: none of this is properly tested yet.</p>

<p>The Kademlia paper has much to say on the issue of routing, most of it contradictory. My takeaway from many readings and from browsing the source code of various different implementations is that the following points are the most important:</p>

<ul>
<li>each bucket should contain at most <em>K</em> nodes</li>
<li>we should only ever report node addresses which we have personally confirmed exist</li>
<li>responsive nodes should never be removed from buckets</li>
<li>nodes should never be removed from buckets unless a suitable replacement exists</li>
</ul>


<p>The first three points make the routing table very resistant to flooding and spoofing. In particular, they prevent a common attack for p2p networks where some bad guy floods the routing tables of all the other nodes so that all traffic is routed through nodes controlled by the bad guy. The last point prevents nodes from flushing their routing tables if their own network connection goes down.</p>

<p>I think the implementation I have come up with is fairly clean, if a little lengthy. Like the bit_tree I want the bucket to be completely pure. All side effects will be handled by the router itself. The main data structures are explained pretty well by the comments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">K</span><span class="p">,</span> <span class="o">?</span><span class="nv">DIAL_DEPTH</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">node</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">address</span><span class="p">,</span> <span class="c">% node #address{} record</span>
</span><span class='line'>    <span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="c">% node end</span>
</span><span class='line'>    <span class="n">suffix</span><span class="p">,</span> <span class="c">% the remaining bits of the nodes end left over from the bit_tree</span>
</span><span class='line'>    <span class="n">status</span><span class="p">,</span> <span class="c">% one of [live, stale, cache]</span>
</span><span class='line'>    <span class="n">last_seen</span> <span class="c">% for live/stale nodes, the time of the last received message. for cache nodes the time of the last .see reference to the node</span>
</span><span class='line'>   <span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">bucket</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">nodes</span><span class="p">,</span> <span class="c">% gb_tree mapping addresses to {Status, Last_seen}</span>
</span><span class='line'>    <span class="c">% remaining fields are pq&#39;s of nodes sorted by their last_seen field</span>
</span><span class='line'>    <span class="n">live</span><span class="p">,</span> <span class="c">% nodes currently expected to be alive</span>
</span><span class='line'>    <span class="n">stale</span><span class="p">,</span> <span class="c">% nodes which have not replied recently</span>
</span><span class='line'>    <span class="n">cache</span> <span class="c">% potential nodes which we have not yet verified </span>
</span><span class='line'>   <span class="p">}).</span> <span class="c">% invariant: pq_maps:size(live) + pq_maps:size(stale) &lt;= ?K</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bucket is a two-stage data structure. This allows us the keep nodes of different statuses sorted by the last_seen time but still be able to get/delete nodes just knowing the address. The <em>get_node</em> function should make it clear how this works:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">get_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span>
</span><span class='line'>   <span class="nl">#bucket</span><span class="p">{</span><span class="nb">nodes</span><span class="o">=</span><span class="nv">Nodes</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="nv">Live</span><span class="p">,</span> <span class="n">stale</span><span class="o">=</span><span class="nv">Stale</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="nv">Cache</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">gb_trees</span><span class="p">:</span><span class="n">lookup</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Nodes</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>  <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="nv">Status</span><span class="p">,</span> <span class="nv">Last_seen</span><span class="p">}}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="k">case</span> <span class="nv">Status</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">live</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="nb">get</span><span class="p">({</span><span class="nv">Last_seen</span><span class="p">,</span> <span class="nv">Address</span><span class="p">},</span> <span class="nv">Live</span><span class="p">)};</span>
</span><span class='line'>      <span class="n">stale</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="nb">get</span><span class="p">({</span><span class="nv">Last_seen</span><span class="p">,</span> <span class="nv">Address</span><span class="p">},</span> <span class="nv">Stale</span><span class="p">)};</span>
</span><span class='line'>      <span class="n">cache</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="nb">get</span><span class="p">({</span><span class="nv">Last_seen</span><span class="p">,</span> <span class="nv">Address</span><span class="p">},</span> <span class="nv">Cache</span><span class="p">)}</span>
</span><span class='line'>      <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">none</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">none</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is only long because records are purely a compile time structure ie we can&#8217;t write <em>Bucket#bucket.Status</em> so we have to pattern match on <em>Status</em> instead. We also define <em>add_node/2</em>, <em>del_node/2</em> and <em>update_node/2</em>, which look pretty similar, as well as <em>to_list/1</em>, <em>from_list/1</em> and <em>sizes/1</em>.</p>

<p>The router is going to react to various events by calling the appropriate bucket functions and possibly sending out messages based on the result. The first event it has to handle is a node becoming unresponsive. The bucket will mark this node as stale and return a cache node which the router can attempt to verify.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% this address failed to reply in a timely manner</span>
</span><span class='line'><span class="nf">timedout</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">timing_out</span><span class="p">,</span> <span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">get_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="k">case</span> <span class="nv">Node</span><span class="nl">#node.status</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">live</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% mark as stale, return a cache node that might be a suitable replacement</span>
</span><span class='line'>          <span class="nv">Bucket2</span> <span class="o">=</span> <span class="n">update_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">stale</span><span class="p">},</span> <span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>          <span class="n">pop_cache_hi</span><span class="p">(</span><span class="nv">Bucket2</span><span class="p">);</span>
</span><span class='line'>      <span class="p">_</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% if cache or stale already we don&#39;t care </span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">none</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% wtf? we don&#39;t even know this node?</span>
</span><span class='line'>      <span class="c">% one way this could happen: </span>
</span><span class='line'>      <span class="c">% send N1, sendN1, timedout N1, add N2 (pushing N1 out of stale), timedout N1 </span>
</span><span class='line'>      <span class="nn">log</span><span class="p">:</span><span class="n">warning</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">unknown_node_timedout</span><span class="p">,</span> <span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>      <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="c">% return most recently seen cache node, if any exist</span>
</span><span class='line'><span class="nf">pop_cache_hi</span><span class="p">(</span><span class="nl">#bucket</span><span class="p">{</span><span class="n">cache</span><span class="o">=</span><span class="nv">Cache</span><span class="p">}</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="n">pop_hi</span><span class="p">(</span><span class="nv">Cache</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>  <span class="p">{_</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">Cache2</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="nb">node</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket</span><span class="nl">#bucket</span><span class="p">{</span><span class="n">cache</span><span class="o">=</span><span class="nv">Cache2</span><span class="p">})};</span>
</span><span class='line'>  <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next event is receiving a <em>.see</em> command. This may be as a result of a <em>+end</em> sent by the router but is more likely to be part of a dialing process happening elsewhere. The beauty of Kademlia is that the router can populate the routing table just by listening in on dialing attempts.</p>

<p>For each node listed in the <em>.see</em> command the router will call <em>seen</em>. This adds the node to the cache and returns the least recently seen live node so the router can check that it is still responsive.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% this address has been reported to exist by another node</span>
</span><span class='line'><span class="nf">seen</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">seeing</span><span class="p">,</span> <span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">get_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="k">case</span> <span class="nv">Node</span><span class="nl">#node.status</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">cache</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% for cache nodes being in a .see is good enough</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="n">update_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">last_seen</span><span class="o">=</span><span class="nv">Time</span><span class="p">},</span> <span class="nv">Bucket</span><span class="p">));</span>
</span><span class='line'>      <span class="p">_</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% for live/stale nodes we require direct contact so ignore this</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">none</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% put node in cache, return a live node to ping</span>
</span><span class='line'>      <span class="nv">Node</span> <span class="o">=</span> <span class="nl">#node</span><span class="p">{</span>
</span><span class='line'>        <span class="n">address</span> <span class="o">=</span> <span class="nv">Address</span><span class="p">,</span>
</span><span class='line'>        <span class="n">&#39;end&#39;</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="n">to_end</span><span class="p">(</span><span class="nv">Address</span><span class="p">),</span>
</span><span class='line'>        <span class="n">suffix</span> <span class="o">=</span> <span class="nv">Suffix</span><span class="p">,</span>
</span><span class='line'>        <span class="n">status</span> <span class="o">=</span> <span class="n">cache</span><span class="p">,</span>
</span><span class='line'>        <span class="n">last_seen</span> <span class="o">=</span> <span class="nv">Time</span>
</span><span class='line'>       <span class="p">},</span>
</span><span class='line'>      <span class="nv">Bucket2</span> <span class="o">=</span> <span class="n">add_node</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">peek_live_lo</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">none</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket2</span><span class="p">);</span>
</span><span class='line'>      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Live_node</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nb">node</span><span class="p">,</span> <span class="nv">Live_node</span><span class="p">,</span> <span class="n">ok</span><span class="p">(</span><span class="nv">Bucket2</span><span class="p">)}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="c">% return the oldest live node</span>
</span><span class='line'><span class="nf">peek_live_lo</span><span class="p">(</span><span class="nl">#bucket</span><span class="p">{</span><span class="n">live</span><span class="o">=</span><span class="nv">Live</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="n">peek_lo</span><span class="p">(</span><span class="nv">Live</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>  <span class="n">none</span> <span class="o">-&gt;</span> <span class="n">none</span><span class="p">;</span>
</span><span class='line'>  <span class="p">{_,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Any time we receive a message we learn that the node sending it exists (or not - we&#8217;ll deal with address spoofing in a later post) so we can potentially mark it as a live node. The <em>touched</em> function checks if the node is already in the bucket or if it needs to be added.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% this address has been verified as actually existing</span>
</span><span class='line'><span class="nf">touched</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">May_split</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">touching</span><span class="p">,</span> <span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">get_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="k">of</span>
</span><span class='line'>  <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="k">case</span> <span class="nv">Node</span><span class="nl">#node.status</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">live</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% update last_seen time</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="n">update_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">last_seen</span><span class="o">=</span><span class="nv">Time</span><span class="p">},</span> <span class="nv">Bucket</span><span class="p">));</span>
</span><span class='line'>      <span class="n">stale</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% update last_seen time and promote to live</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="n">update_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">last_seen</span><span class="o">=</span><span class="nv">Time</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">live</span><span class="p">},</span> <span class="nv">Bucket</span><span class="p">));</span>
</span><span class='line'>      <span class="n">cache</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="c">% potentially promote the node to live</span>
</span><span class='line'>          <span class="nv">Bucket2</span> <span class="o">=</span> <span class="n">del_node</span><span class="p">(</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>          <span class="n">new_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">Bucket2</span><span class="p">,</span> <span class="nv">May_split</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">none</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% potentially add the node to live</span>
</span><span class='line'>      <span class="n">new_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">May_split</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the node needs to be added then <em>touched</em> calls <em>new_node</em> which decides if there is space in the bucket and, if so, adds the new node. If the bucket is full and <em>May_split</em> is true then <em>new_node</em> will split the bucket before adding the new node. Deciding whether or not splitting is allowed is the routers job.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% assumes Address is not already in Bucket, otherwise crashes</span>
</span><span class='line'><span class="nf">new_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">May_split</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Node</span> <span class="o">=</span> <span class="nl">#node</span><span class="p">{</span>
</span><span class='line'>      <span class="n">address</span> <span class="o">=</span> <span class="nv">Address</span><span class="p">,</span>
</span><span class='line'>      <span class="n">&#39;end&#39;</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="n">to_end</span><span class="p">(</span><span class="nv">Address</span><span class="p">),</span>
</span><span class='line'>      <span class="n">suffix</span> <span class="o">=</span> <span class="nv">Suffix</span><span class="p">,</span>
</span><span class='line'>      <span class="n">status</span> <span class="o">=</span> <span class="n">undefined</span><span class="p">,</span>
</span><span class='line'>      <span class="n">last_seen</span> <span class="o">=</span> <span class="nv">Time</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Lives</span><span class="p">,</span> <span class="nv">Stales</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>  <span class="nv">Lives</span> <span class="o">+</span> <span class="nv">Stales</span> <span class="o">&lt;</span> <span class="o">?</span><span class="nv">K</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% space left in live</span>
</span><span class='line'>      <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">adding</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>      <span class="n">ok</span><span class="p">(</span><span class="n">add_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">live</span><span class="p">},</span> <span class="nv">Bucket</span><span class="p">));</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">Lives</span> <span class="o">&lt;</span> <span class="o">?</span><span class="nv">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nv">Stales</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% space left in live if we push something out of stale</span>
</span><span class='line'>      <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">adding</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>      <span class="nv">Bucket2</span> <span class="o">=</span> <span class="n">drop_stale</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>      <span class="n">ok</span><span class="p">(</span><span class="n">add_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">live</span><span class="p">},</span> <span class="nv">Bucket2</span><span class="p">));</span>
</span><span class='line'>  <span class="nv">May_split</span> <span class="ow">and</span> <span class="p">(</span><span class="nv">Suffix</span> <span class="o">/=</span> <span class="p">[])</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% allowed to split the bucket to make space</span>
</span><span class='line'>      <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">splitting</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>      <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="nv">BucketF</span><span class="p">,</span> <span class="nv">BucketT</span><span class="p">}</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>      <span class="p">[</span><span class="nv">Bit</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">]</span> <span class="o">=</span> <span class="nv">Suffix</span><span class="p">,</span>
</span><span class='line'>      <span class="k">case</span> <span class="nv">Bit</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="nv">BucketF2</span> <span class="o">=</span> <span class="n">new_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">BucketF</span><span class="p">,</span> <span class="nv">May_split</span><span class="p">),</span>
</span><span class='line'>          <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="nv">BucketF2</span><span class="p">,</span> <span class="nv">BucketT</span><span class="p">};</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>          <span class="nv">BucketT2</span> <span class="o">=</span> <span class="n">new_node</span><span class="p">(</span><span class="nv">Address</span><span class="p">,</span> <span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Time</span><span class="p">,</span> <span class="nv">BucketT</span><span class="p">,</span> <span class="nv">May_split</span><span class="p">),</span>
</span><span class='line'>          <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="nv">BucketF</span><span class="p">,</span> <span class="nv">BucketT2</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span><span class="p">;</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% not allowed to split, will have to go in the cache</span>
</span><span class='line'>      <span class="nn">log</span><span class="p">:</span><span class="n">info</span><span class="p">([</span><span class="o">?</span><span class="nv">MODULE</span><span class="p">,</span> <span class="n">caching</span><span class="p">,</span> <span class="nv">Node</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">]),</span>
</span><span class='line'>      <span class="n">ok</span><span class="p">(</span><span class="n">add_node</span><span class="p">(</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">status</span><span class="o">=</span><span class="n">cache</span><span class="p">},</span> <span class="n">bucket</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="c">% drop the oldest stale node, crashes if none exist</span>
</span><span class='line'><span class="nf">drop_stale</span><span class="p">(</span><span class="nl">#bucket</span><span class="p">{</span><span class="n">stale</span><span class="o">=</span><span class="nv">Stale</span><span class="p">}</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{_</span><span class="nv">Key</span><span class="p">,</span> <span class="p">_</span><span class="nv">Node</span><span class="p">,</span> <span class="nv">Stale2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="n">pop_one_hi</span><span class="p">(</span><span class="nv">Stale</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Bucket</span><span class="nl">#bucket</span><span class="p">{</span><span class="n">stale</span><span class="o">=</span><span class="nv">Stale2</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">split</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Nodes</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">NodesF</span> <span class="o">=</span> <span class="p">[</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">suffix</span><span class="o">=</span><span class="nv">Suffix2</span><span class="p">}</span> <span class="p">||</span> <span class="nl">#node</span><span class="p">{</span><span class="n">suffix</span><span class="o">=</span><span class="p">[</span><span class="n">false</span><span class="p">|</span><span class="nv">Suffix2</span><span class="p">]}</span><span class="o">=</span><span class="nv">Node</span> <span class="o">&lt;-</span> <span class="nv">Nodes</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">NodesT</span> <span class="o">=</span> <span class="p">[</span><span class="nv">Node</span><span class="nl">#node</span><span class="p">{</span><span class="n">suffix</span><span class="o">=</span><span class="nv">Suffix2</span><span class="p">}</span> <span class="p">||</span> <span class="nl">#node</span><span class="p">{</span><span class="n">suffix</span><span class="o">=</span><span class="p">[</span><span class="n">true</span><span class="p">|</span><span class="nv">Suffix2</span><span class="p">]}</span><span class="o">=</span><span class="nv">Node</span> <span class="o">&lt;-</span> <span class="nv">Nodes</span><span class="p">],</span>
</span><span class='line'>    <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="n">from_list</span><span class="p">(</span><span class="nv">NodesF</span><span class="p">),</span> <span class="n">from_list</span><span class="p">(</span><span class="nv">NodesT</span><span class="p">)}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, upon receiving a <em>+end</em> signal the router needs to reply with a <em>.see</em> command listing the <em>K</em> nearest nodes to the specified end. This will be done using a combination of <em>bit_tree:iter</em> and <em>bucket:nearest</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">nearest</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nv">End</span><span class="p">,</span> <span class="nl">#bucket</span><span class="p">{</span><span class="n">live</span><span class="o">=</span><span class="nv">Live</span><span class="p">,</span> <span class="n">stale</span><span class="o">=</span><span class="nv">Stale</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Nodes</span> <span class="o">=</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="n">to_list</span><span class="p">(</span><span class="nv">Live</span><span class="p">)</span> <span class="o">++</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="n">to_list</span><span class="p">(</span><span class="nv">Stale</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Num_nodes</span> <span class="o">=</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nv">Live</span><span class="p">)</span> <span class="o">+</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="nb">size</span><span class="p">(</span><span class="nv">Stale</span><span class="p">),</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>  <span class="nv">Num_nodes</span> <span class="o">=&lt;</span> <span class="nv">N</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">[</span><span class="nv">Node</span><span class="nl">#node.address</span> <span class="p">||</span> <span class="p">{_</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Nodes</span><span class="p">];</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% !!! maybe should prefer to return live nodes even if further away</span>
</span><span class='line'>      <span class="nv">Nodes_by_dist</span> <span class="o">=</span> <span class="p">[{</span><span class="nn">util</span><span class="p">:</span><span class="n">distance</span><span class="p">(</span><span class="nv">End</span><span class="p">,</span> <span class="nv">Node</span><span class="nl">#node.&#39;end&#39;</span><span class="p">),</span> <span class="nv">Node</span><span class="p">}</span> <span class="p">||</span> <span class="p">{_</span><span class="nv">Key</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nn">pq_maps</span><span class="p">:</span><span class="n">to_list</span><span class="p">(</span><span class="nv">Live</span><span class="p">)],</span>
</span><span class='line'>      <span class="p">{</span><span class="nv">Closest</span><span class="p">,</span> <span class="p">_}</span> <span class="o">=</span> <span class="nn">lists</span><span class="p">:</span><span class="n">split</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span> <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="p">(</span><span class="nv">Nodes_by_dist</span><span class="p">)),</span>
</span><span class='line'>      <span class="p">[</span><span class="nv">Node</span><span class="nl">#node.address</span> <span class="p">||</span> <span class="p">{_</span><span class="nv">Dist</span><span class="p">,</span> <span class="nv">Node</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Closest</span><span class="p">]</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>As usual all the code is sitting in the <a href="https://github.com/jamii/erl-telehash">repo</a>.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2011-03-30T06:16:00+01:00" pubdate data-updated="true">30 Mar 2011</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/telehash/'>telehash</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><div class="ps">I am often available for consulting work. Check out my <a href="/about.html">resume</a>.</div>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'scattered-thoughts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://scattered-thoughts.net/blog/2011/03/30/telehash-buckets/';
        var disqus_url = 'http://scattered-thoughts.net/blog/2011/03/30/telehash-buckets/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-18515092-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>