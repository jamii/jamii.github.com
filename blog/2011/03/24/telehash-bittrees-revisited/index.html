
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Telehash: bit_trees revisited - Scattered Thoughts</title>
	<meta name="author" content="Jamie Brandon">

	
	<meta name="description" content="It has been suggested that the bit_trees presented in my last post are overly complicated. Indeed, in the cold light of the morning there is &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Scattered Thoughts</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:scattered-thoughts.net">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="email" href="mailto:jamie@scattered-thoughts.net" title="Email">Email</a>
		
		
		
		
		
		<a class="github" href="https://github.com/jamii" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:scattered-thoughts.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Telehash: bit_trees revisited</h1>
	<div class="entry-content"><p>It has been suggested that the bit_trees presented in my last post are overly complicated. Indeed, in the cold light of the morning there is absolutely no need for that zipper. Without further ado, here is the much simpler version.</p>

<!--more-->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% implements the tree part of kademlias k-buckets</span>
</span><span class='line'><span class="c">% a bit_tree maps ends (lists of bits) to buckets</span>
</span><span class='line'><span class="c">% as far as the bit_tree is concerned the buckets are completely opaque</span>
</span><span class='line'><span class="c">% the bit_tree also calculates various numbers needed for splitting decisions</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">bit_tree</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;conf.hrl&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">empty</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">update</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">iter</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% a bit_tree is either a leaf or a branch</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">leaf</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">size</span><span class="p">,</span> <span class="c">% size of bucket</span>
</span><span class='line'>    <span class="n">bucket</span> <span class="c">% some opaque bucket of stuff</span>
</span><span class='line'>   <span class="p">}).</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">branch</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">size</span><span class="p">,</span> <span class="c">% size(childF) + size(childT)</span>
</span><span class='line'>    <span class="n">childF</span><span class="p">,</span> <span class="c">% tree containing nodes whose next bit is false</span>
</span><span class='line'>    <span class="n">childT</span> <span class="c">% tree containing nodes whose next bit is true</span>
</span><span class='line'>   <span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% --- api ---</span>
</span><span class='line'>
</span><span class='line'><span class="nf">empty</span><span class="p">(</span><span class="nv">Size</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">}.</span>
</span><span class='line'>      
</span><span class='line'><span class="nf">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Self</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_function</span><span class="p">(</span><span class="nv">Fun</span><span class="p">),</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">Bits</span><span class="p">),</span> <span class="nb">is_list</span><span class="p">(</span><span class="nv">Self</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="nv">Self</span><span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">,</span> <span class="nv">Depth</span><span class="p">,</span> <span class="nl">#leaf</span><span class="p">{</span><span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Gap_size</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Gap</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">{</span><span class="n">gap</span><span class="p">,</span> <span class="nv">G</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">G</span><span class="p">;</span>
</span><span class='line'>      <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Fun</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Depth</span><span class="p">,</span> <span class="nv">Gap_size</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">));</span>
</span><span class='line'><span class="nf">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Self</span><span class="p">,</span> <span class="nv">Depth</span><span class="p">,</span> <span class="nl">#branch</span><span class="p">{</span><span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">[</span><span class="nv">Next</span><span class="p">|</span><span class="nv">Bits2</span><span class="p">]</span> <span class="o">=</span> <span class="nv">Bits</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Self2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Self</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">{</span><span class="n">gap</span><span class="p">,</span> <span class="p">_}</span> <span class="o">-&gt;</span> <span class="nv">Self</span><span class="p">;</span>
</span><span class='line'>      <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="p">[</span><span class="nv">Next</span><span class="p">|</span><span class="nv">Rest</span><span class="p">]}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="nv">Rest</span><span class="p">};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="p">[</span><span class="n">false</span><span class="p">|_]}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">gap</span><span class="p">,</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">)};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="p">[</span><span class="n">true</span><span class="p">|_]}</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">gap</span><span class="p">,</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">)}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Depth2</span> <span class="o">=</span> <span class="nv">Depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">Next</span> <span class="k">of</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">ChildT2</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Bits2</span><span class="p">,</span> <span class="nv">Self2</span><span class="p">,</span> <span class="nv">Depth2</span><span class="p">,</span> <span class="nv">ChildT</span><span class="p">),</span>
</span><span class='line'>      <span class="nv">Size</span> <span class="o">=</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">)</span> <span class="o">+</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildT2</span><span class="p">),</span>
</span><span class='line'>      <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT2</span><span class="p">};</span>
</span><span class='line'>  <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">ChildF2</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Bits2</span><span class="p">,</span> <span class="nv">Self2</span><span class="p">,</span> <span class="nv">Depth2</span><span class="p">,</span> <span class="nv">ChildF</span><span class="p">),</span>
</span><span class='line'>      <span class="nv">Size</span> <span class="o">=</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildF2</span><span class="p">)</span> <span class="o">+</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">),</span>
</span><span class='line'>      <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">childF</span><span class="o">=</span><span class="nv">ChildF2</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to Bits</span>
</span><span class='line'><span class="nf">iter</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">iter</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">,</span> <span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">done</span> <span class="k">end</span><span class="p">).</span>
</span><span class='line'>          
</span><span class='line'><span class="nf">iter</span><span class="p">(_</span><span class="nv">Bits</span><span class="p">,</span> <span class="nl">#leaf</span><span class="p">{</span><span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">},</span> <span class="nv">Iter</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="nf">iter</span><span class="p">([</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Bits</span><span class="p">],</span> <span class="nl">#branch</span><span class="p">{</span><span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">},</span> <span class="nv">Iter</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">Bit</span> <span class="k">of</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">iter</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">ChildT</span><span class="p">,</span> <span class="n">iter</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">ChildF</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">));</span>
</span><span class='line'>  <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">iter</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">ChildF</span><span class="p">,</span> <span class="n">iter</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">ChildT</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="c">% --- internal functions ---</span>
</span><span class='line'>
</span><span class='line'><span class="nf">tree_size</span><span class="p">(</span><span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Size</span><span class="p">;</span>
</span><span class='line'><span class="nf">tree_size</span><span class="p">(</span><span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Size</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bucket_update_to_tree</span><span class="p">({</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Size</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">};</span>
</span><span class='line'><span class="nf">bucket_update_to_tree</span><span class="p">({</span><span class="n">split</span><span class="p">,</span> <span class="nv">SplitF</span><span class="p">,</span> <span class="nv">SplitT</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">ChildF</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">SplitF</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">ChildT</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">SplitT</span><span class="p">),</span>
</span><span class='line'>    <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">)</span><span class="o">+</span><span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">),</span> <span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="c">% --- end ---</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the corresponding test code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% simple buckets used for testing bit_tree</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">test_bucket</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;conf.hrl&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">bits</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">add</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">split</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">add_to_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">make_tree</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">distance</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">list_from</span><span class="o">/</span><span class="mi">2</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">MAX_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">BITS</span><span class="p">,</span> <span class="o">?</span><span class="nv">END_BITS</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">util</span><span class="p">:</span><span class="n">to_bits</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Int</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">split</span><span class="p">([{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Bucket</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">split</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>  <span class="nb">length</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">?</span><span class="nv">MAX_SIZE</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">BucketF</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Int2</span><span class="p">}</span> <span class="p">||</span> <span class="p">{[</span><span class="n">false</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">],</span> <span class="nv">Int2</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">],</span>
</span><span class='line'>      <span class="nv">BucketT</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Int2</span><span class="p">}</span> <span class="p">||</span> <span class="p">{[</span><span class="n">true</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">],</span> <span class="nv">Int2</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">],</span>
</span><span class='line'>      <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="n">split</span><span class="p">(</span><span class="nv">BucketF</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="nv">BucketT</span><span class="p">)};</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span> <span class="nv">Bucket</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add_to_tree</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">bit_tree</span><span class="p">:</span><span class="n">update</span><span class="p">(</span>
</span><span class='line'>      <span class="k">fun</span> <span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="p">_</span><span class="nv">Depth</span><span class="p">,</span> <span class="p">_</span><span class="nv">Gap_size</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="n">add</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>      <span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span>
</span><span class='line'>      <span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="c">% dont care about gap for now</span>
</span><span class='line'>      <span class="nv">Tree</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">make_tree</span><span class="p">(</span><span class="nv">Ints</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Tree</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[]),</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="n">foldl</span><span class="p">(</span><span class="k">fun</span> <span class="n">add_to_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">,</span> <span class="nv">Ints</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">distance</span><span class="p">(</span><span class="nv">IntA</span><span class="p">,</span> <span class="nv">IntB</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">util</span><span class="p">:</span><span class="n">distance</span><span class="p">({</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">IntA</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">},</span> <span class="p">{</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">IntB</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% output *should* be in ascending order</span>
</span><span class='line'><span class="nf">list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">List</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="n">iter_to_list</span><span class="p">(</span><span class="nn">bit_tree</span><span class="p">:</span><span class="n">iter</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">)),</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="p">(</span>
</span><span class='line'>      <span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="p">([{</span><span class="n">distance</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Elem</span><span class="p">),</span> <span class="nv">Elem</span><span class="p">}</span> <span class="p">||</span> <span class="p">{_,</span><span class="nv">Elem</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">])</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>      <span class="nv">List</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>

</div>


<div class="meta">
	<div class="date">








  


<time datetime="2011-03-24T06:16:00+00:00" pubdate data-updated="true">24 Mar 2011</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/telehash/'>telehash</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><div class="ps">I am often available for consulting work. Check out my <a href="/about.html">resume</a>.</div>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'scattered-thoughts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://scattered-thoughts.net/blog/2011/03/24/telehash-bittrees-revisited/';
        var disqus_url = 'http://scattered-thoughts.net/blog/2011/03/24/telehash-bittrees-revisited/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-18515092-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>