
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Telehash: bit_trees - Scattered Thoughts</title>
	<meta name="author" content="Jamie Brandon">

	
	<meta name="description" content="The next step in building a switch is managing a routing table. Actually, the next step is handling sessions via ring/line but I&rsquo;m still &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Scattered Thoughts</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
	<li><a href="/about.html">About</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:scattered-thoughts.net">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		<a class="email" href="mailto:jamie@scattered-thoughts.net" title="Email">Email</a>
		
		
		
		
		
		<a class="github" href="https://github.com/jamii" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:scattered-thoughts.net">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h1 class="title">Telehash: bit_trees</h1>
	<div class="entry-content"><p>The next step in building a switch is managing a routing table. Actually, the next step is handling sessions via <em>ring/</em>line but I&rsquo;m still mulling over the protocol so we&rsquo;ll skip to the routing table.</p>

<!--more-->


<p>I&rsquo;ll add the usual &lsquo;I don&rsquo;t understand Kademlia and I didn&rsquo;t test my code&rsquo; disclaimer in here.</p>

<p>Routing in the Kademlia paper is described using what can best be called the &lsquo;mash everything together and be vague about the details&rsquo; pattern. I want my switch to be a bit cleaner than that so I&rsquo;ve split it into three modules. The first of these is the bit_tree.</p>

<p>The bit_tree is a suffix tree which maps ends (lists of bits) to buckets. The bit_tree neither knows nor cares what a bucket is and for now you don&rsquo;t either. The utility of this tree comes down to one important property: the floor of the log (base 2) of the XOR distance between two ends is the height of the smallest sub-tree which contains both of them. Got that? For example, if log(distance(EndA,EndB)) == 7.234&hellip; then the height of the smallest sub-tree containing both EndA and EndB is 7 nodes. This makes it easy to locate the nearest known nodes to a specified end, something we are supposed to do in response to a <em>.see</em> command.</p>

<p>So here is a bog-standard binary suffix tree:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% a bit_tree is either a leaf or a branch</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">leaf</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">size</span><span class="p">,</span> <span class="c">% size of bucket</span>
</span><span class='line'>    <span class="n">bucket</span> <span class="c">% some opaque bucket of stuff</span>
</span><span class='line'>   <span class="p">}).</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">branch</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">size</span><span class="p">,</span> <span class="c">% size(childF) + size(childT)</span>
</span><span class='line'>    <span class="n">childF</span><span class="p">,</span> <span class="c">% tree containing nodes whose next bit is false</span>
</span><span class='line'>    <span class="n">childT</span> <span class="c">% % tree containing nodes whose next bit is true</span>
</span><span class='line'>   <span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>When adding nodes to a bucket we need to keep track of certain numbers which will be used by the router to decide when to split buckets. Some of these are quite complicated so to make this easier we will work with a zipper-like structure instead of using <em>leaf</em> and <em>branch</em> directly. If you know what a zipper is the code in this post will make sense. If you don&rsquo;t know what a zipper is, go find out. When you come back the code in this post will make sense.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% zipper-esque structure marking a position in a bit_tree</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">finger</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sizer</span><span class="p">,</span> <span class="c">% a size function for buckets</span>
</span><span class='line'>    <span class="n">tree</span><span class="p">,</span> <span class="c">% current sub-tree</span>
</span><span class='line'>    <span class="n">self</span><span class="p">,</span> <span class="c">% the path *to* self (the nodes own end). either {down, Down_bits} or {up, Up_bits, Down_bits, Gap}</span>
</span><span class='line'>      <span class="c">% where Gap is the size of the largest tree containing self but not touching this finger</span>
</span><span class='line'>    <span class="n">depth</span><span class="p">,</span> <span class="c">% the number of bits away from the root tree</span>
</span><span class='line'>    <span class="n">zipper</span> <span class="c">% a list of {Bit, Tree} pairs marking branches NOT taken</span>
</span><span class='line'>   <span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The finger keeps track of where the nodes own end is located in the tree in order to calculate something I have termed the gap &ndash; the size of the largest sub-tree containing the nodes own end but not touching the finger.</p>

<p>The empty bit_tree is easy to define:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">empty</span><span class="p">(</span><span class="nv">Self</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Sizer</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>       <span class="n">sizer</span> <span class="o">=</span> <span class="nv">Sizer</span><span class="p">,</span>
</span><span class='line'>       <span class="n">tree</span> <span class="o">=</span> <span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Sizer</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span> <span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">},</span>
</span><span class='line'>       <span class="n">self</span> <span class="o">=</span> <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="nv">Self</span><span class="p">},</span>
</span><span class='line'>       <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>       <span class="n">zipper</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>      <span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Moving around within the tree is a little more complicated but if you already went away and read about zippers it should feel familiar. Most of the work is in keeping track of the gap.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">extend</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nl">#finger</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="nl">#leaf</span><span class="p">{}}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c">% must always end on a leaf</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Finger</span><span class="p">};</span>
</span><span class='line'><span class="nf">extend</span><span class="p">([</span><span class="nv">Next</span> <span class="p">|</span> <span class="nv">Bits</span><span class="p">],</span>
</span><span class='line'>       <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>   <span class="n">tree</span> <span class="o">=</span> <span class="nl">#branch</span><span class="p">{</span><span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">},</span>
</span><span class='line'>   <span class="n">self</span> <span class="o">=</span> <span class="nv">Self</span><span class="p">,</span>
</span><span class='line'>   <span class="n">depth</span> <span class="o">=</span> <span class="nv">Depth</span><span class="p">,</span>
</span><span class='line'>   <span class="n">zipper</span> <span class="o">=</span> <span class="nv">Zipper</span>
</span><span class='line'>  <span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Branch_taken</span><span class="p">,</span> <span class="nv">Branch_missed</span><span class="p">}</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Next</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">false</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">ChildF</span><span class="p">,</span> <span class="nv">ChildT</span><span class="p">};</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">ChildT</span><span class="p">,</span> <span class="nv">ChildF</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Self2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Self</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="nv">Up</span><span class="p">,</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% already stepped out of gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[</span><span class="ow">not</span><span class="p">(</span><span class="nv">Next</span><span class="p">)|</span><span class="nv">Up</span><span class="p">],</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Down</span><span class="p">]}</span> <span class="k">when</span> <span class="nv">Bit</span> <span class="o">==</span> <span class="nv">Next</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% still in the gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="nv">Down</span><span class="p">};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Down</span><span class="p">]}</span> <span class="k">when</span> <span class="nv">Bit</span> <span class="o">/=</span> <span class="nv">Next</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% leaving gap, check its size</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[</span><span class="ow">not</span><span class="p">(</span><span class="nv">Next</span><span class="p">)],</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Down</span><span class="p">],</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">Branch_missed</span><span class="p">)}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Depth2</span> <span class="o">=</span> <span class="nv">Depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Zipper2</span> <span class="o">=</span> <span class="p">[{</span><span class="ow">not</span><span class="p">(</span><span class="nv">Next</span><span class="p">),</span> <span class="nv">Branch_missed</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Zipper</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">Finger2</span> <span class="o">=</span> <span class="nv">Finger</span><span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>      <span class="n">tree</span> <span class="o">=</span> <span class="nv">Branch_taken</span><span class="p">,</span>
</span><span class='line'>      <span class="n">self</span> <span class="o">=</span> <span class="nv">Self2</span><span class="p">,</span>
</span><span class='line'>      <span class="n">depth</span> <span class="o">=</span> <span class="nv">Depth2</span><span class="p">,</span>
</span><span class='line'>      <span class="n">zipper</span> <span class="o">=</span> <span class="nv">Zipper2</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>    <span class="n">extend</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Finger2</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">retract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Finger</span><span class="p">;</span>
</span><span class='line'><span class="nf">retract</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>    <span class="n">tree</span> <span class="o">=</span> <span class="nv">Tree</span><span class="p">,</span>
</span><span class='line'>    <span class="n">self</span> <span class="o">=</span> <span class="nv">Self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">depth</span> <span class="o">=</span> <span class="nv">Depth</span><span class="p">,</span>
</span><span class='line'>    <span class="n">zipper</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Last</span><span class="p">,</span><span class="nv">Branch</span><span class="p">}|</span><span class="nv">Zipper</span><span class="p">]</span>
</span><span class='line'>   <span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="k">when</span> <span class="nv">N</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Size</span> <span class="o">=</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">Tree</span><span class="p">)</span> <span class="o">+</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">Branch</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Tree2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Last</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">false</span> <span class="o">-&gt;</span> <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">childF</span><span class="o">=</span><span class="nv">Branch</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">Tree</span><span class="p">};</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">-&gt;</span> <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">childF</span><span class="o">=</span><span class="nv">Tree</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">Branch</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Self2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Self</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="nv">Down</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% already in gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Last</span><span class="p">|</span><span class="nv">Down</span><span class="p">]};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">Down</span><span class="p">,</span> <span class="p">_</span><span class="nv">Gap</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% just entered gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Last</span><span class="p">|</span><span class="nv">Down</span><span class="p">]};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Up</span><span class="p">],</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% still outside gap</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">=</span> <span class="p">(</span><span class="nv">Bit</span><span class="o">==</span><span class="nv">Last</span><span class="p">),</span> <span class="c">% assert</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="nv">Up</span><span class="p">,</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Depth2</span> <span class="o">=</span> <span class="nv">Depth</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Finger2</span> <span class="o">=</span>
</span><span class='line'>  <span class="nv">Finger</span><span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>    <span class="n">tree</span><span class="o">=</span><span class="nv">Tree2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">self</span><span class="o">=</span><span class="nv">Self2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">depth</span><span class="o">=</span><span class="nv">Depth2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">zipper</span><span class="o">=</span><span class="nv">Zipper</span>
</span><span class='line'>   <span class="p">},</span>
</span><span class='line'>    <span class="n">retract</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Finger2</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <em>extend</em> and <em>retract</em> functions are only used internally. We export a much simpler function, <em>move_to</em>, which moves the finger to point at the bucket corresponding to the specified end.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">move_to</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nl">#finger</span><span class="p">{</span><span class="n">depth</span><span class="o">=</span><span class="nv">Depth</span><span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="k">when</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Bits</span><span class="p">)</span> <span class="o">==</span> <span class="o">?</span><span class="nv">END_BITS</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">% !!! naive version</span>
</span><span class='line'>    <span class="n">extend</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="n">retract</span><span class="p">(</span><span class="nv">Depth</span><span class="p">,</span> <span class="nv">Finger</span><span class="p">)).</span>
</span></code></pre></td></tr></table></div></figure>


<p>We could make this more efficient by only retracting until the finger meets <em>Bits</em> partway up. For now I don&rsquo;t expect performance of the bit_tree to be an issue.</p>

<p>Now that we can find buckets we can modify them. Deciding when to split buckets is not the concern of the bit_tree so we delegate it to the caller.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span>
</span><span class='line'>       <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>   <span class="n">sizer</span><span class="o">=</span><span class="nv">Sizer</span><span class="p">,</span>
</span><span class='line'>   <span class="n">tree</span><span class="o">=</span><span class="nl">#leaf</span><span class="p">{</span><span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">}</span>
</span><span class='line'>  <span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Tree</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)),</span>
</span><span class='line'>    <span class="nv">Finger</span><span class="nl">#finger</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="nv">Tree</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Sizer</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span> <span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">};</span>
</span><span class='line'><span class="nf">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="nv">SplitF</span><span class="p">,</span> <span class="nv">SplitT</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">ChildF</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="nv">SplitF</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">ChildT</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="nv">SplitT</span><span class="p">),</span>
</span><span class='line'>    <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">)</span><span class="o">+</span><span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">),</span> <span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to handle <em>.see</em> commands the <em>iter</em> function is used to return buckets in order of distance from the specified end. Here we are making use of the aforementioned nice properties of the bit_tree in order to efficiently return the buckets in order.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to (current position ++ Suffix)</span>
</span><span class='line'><span class="nf">iter</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nl">#finger</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="nv">Tree</span><span class="p">,</span> <span class="n">zipper</span><span class="o">=</span><span class="nv">Zipper</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">Tree</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="n">iter_zipper</span><span class="p">(</span><span class="nv">Zipper</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">)).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to (current position ++ Suffix)</span>
</span><span class='line'><span class="nf">iter_zipper</span><span class="p">([],</span> <span class="p">_</span><span class="nv">Suffix</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">done</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="nf">iter_zipper</span><span class="p">([{</span><span class="nv">Bit</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Zipper</span><span class="p">],</span> <span class="nv">Suffix</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">Tree</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="n">iter_zipper</span><span class="p">(</span><span class="nv">Zipper</span><span class="p">,</span> <span class="p">[</span><span class="ow">not</span><span class="p">(</span><span class="nv">Bit</span><span class="p">)|</span><span class="nv">Suffix</span><span class="p">])).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to Bits, then hand over to Iter</span>
</span><span class='line'><span class="nf">iter_buckets</span><span class="p">(</span><span class="nl">#leaf</span><span class="p">{</span><span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">},</span> <span class="p">_</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="nf">iter_buckets</span><span class="p">(</span><span class="nl">#branch</span><span class="p">{</span><span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">},</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Bits</span><span class="p">],</span> <span class="nv">Iter</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">Bit</span> <span class="k">of</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">));</span>
</span><span class='line'>  <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will typically be called like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="n">move_to</span><span class="p">(</span><span class="nn">util</span><span class="p">:</span><span class="n">to_bits</span><span class="p">(</span><span class="nv">End</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">),</span>
</span><span class='line'><span class="nn">bit_tree</span><span class="p">:</span><span class="n">iter</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Splitting the routing table into separate structures like this makes for easier testing. The bit_tree can be tested independently using really simple buckets where the elements are just integers and the buckets split when they reach more than three elements.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% simple buckets used for testing bit_tree</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">test_bucket</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;conf.hrl&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">bits</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">add</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">split</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">move_to</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">add_to_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">make_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">distance</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">move_list_from</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">list_from</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">MAX_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">BITS</span><span class="p">,</span> <span class="o">?</span><span class="nv">END_BITS</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">util</span><span class="p">:</span><span class="n">to_bits</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Int</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">split</span><span class="p">([{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Bucket</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">split</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>  <span class="nb">length</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">?</span><span class="nv">MAX_SIZE</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">BucketF</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Int2</span><span class="p">}</span> <span class="p">||</span> <span class="p">{[</span><span class="n">false</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">],</span> <span class="nv">Int2</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">],</span>
</span><span class='line'>      <span class="nv">BucketT</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Int2</span><span class="p">}</span> <span class="p">||</span> <span class="p">{[</span><span class="n">true</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">],</span> <span class="nv">Int2</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">],</span>
</span><span class='line'>      <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="n">split</span><span class="p">(</span><span class="nv">BucketF</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="nv">BucketT</span><span class="p">)};</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">move_to</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">bit_tree</span><span class="p">:</span><span class="n">move_to</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add_to_tree</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">}</span> <span class="o">=</span> <span class="n">move_to</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">bit_tree</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">make_tree</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Ints</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Tree</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="n">empty</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="p">[],</span> <span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="n">foldl</span><span class="p">(</span><span class="k">fun</span> <span class="n">add_to_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">,</span> <span class="nv">Ints</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">distance</span><span class="p">(</span><span class="nv">IntA</span><span class="p">,</span> <span class="nv">IntB</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">util</span><span class="p">:</span><span class="n">distance</span><span class="p">({</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">IntA</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">},</span> <span class="p">{</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">IntB</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% output *should* be in ascending order</span>
</span><span class='line'><span class="nf">move_list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="n">move_to</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">),</span>
</span><span class='line'>    <span class="n">list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">List</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="n">iter_to_list</span><span class="p">(</span><span class="nn">bit_tree</span><span class="p">:</span><span class="n">iter</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)),</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="n">map</span><span class="p">(</span>
</span><span class='line'>      <span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="p">([{</span><span class="n">distance</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Elem</span><span class="p">),</span> <span class="nv">Elem</span><span class="p">}</span> <span class="p">||</span> <span class="p">{_,</span><span class="nv">Elem</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">])</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>      <span class="nv">List</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can play around with the test buckets a bit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="mi">25</span><span class="o">&gt;</span> <span class="nv">Tree</span> <span class="o">=</span> <span class="nn">test_bucket</span><span class="p">:</span><span class="n">make_tree</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="nn">lists</span><span class="p">:</span><span class="n">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">)).</span>
</span><span class='line'><span class="p">{</span><span class="n">finger</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">test_bucket</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">121651971</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">1</span><span class="p">,[{[</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">],</span><span class="mi">1000</span><span class="p">}]},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">up</span><span class="p">,[</span><span class="n">false</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span>
</span><span class='line'>             <span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span>
</span><span class='line'>             <span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">|...],</span>
</span><span class='line'>            <span class="p">[</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span>
</span><span class='line'>             <span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">|...],</span>
</span><span class='line'>            <span class="mi">0</span><span class="p">},</span>
</span><span class='line'>        <span class="mi">157</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[{</span><span class="n">false</span><span class="p">,{</span><span class="n">branch</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
</span><span class='line'>                        <span class="p">{</span><span class="n">branch</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">993</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">992</span><span class="p">}]},</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">995</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">994</span><span class="p">}]}},</span>
</span><span class='line'>                        <span class="p">{</span><span class="n">branch</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">997</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">996</span><span class="p">}]},</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">999</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">998</span><span class="p">}]}}}},</span>
</span><span class='line'>         <span class="p">{...}|...]}</span>
</span><span class='line'><span class="mi">26</span><span class="o">&gt;</span> <span class="nv">List</span> <span class="o">=</span> <span class="nn">test_bucket</span><span class="p">:</span><span class="n">move_list_from</span><span class="p">(</span><span class="mi">657</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">).</span>
</span><span class='line'><span class="p">[[{</span><span class="mi">0</span><span class="p">,</span><span class="mi">657</span><span class="p">},{</span><span class="mi">1</span><span class="p">,</span><span class="mi">656</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">2</span><span class="p">,</span><span class="mi">659</span><span class="p">},{</span><span class="mi">3</span><span class="p">,</span><span class="mi">658</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">4</span><span class="p">,</span><span class="mi">661</span><span class="p">},{</span><span class="mi">5</span><span class="p">,</span><span class="mi">660</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">6</span><span class="p">,</span><span class="mi">663</span><span class="p">},{</span><span class="mi">7</span><span class="p">,</span><span class="mi">662</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">8</span><span class="p">,</span><span class="mi">665</span><span class="p">},{</span><span class="mi">9</span><span class="p">,</span><span class="mi">664</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">10</span><span class="p">,</span><span class="mi">667</span><span class="p">},{</span><span class="mi">11</span><span class="p">,</span><span class="mi">666</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">12</span><span class="p">,</span><span class="mi">669</span><span class="p">},{</span><span class="mi">13</span><span class="p">,</span><span class="mi">668</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">14</span><span class="p">,</span><span class="mi">671</span><span class="p">},{</span><span class="mi">15</span><span class="p">,</span><span class="mi">670</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">16</span><span class="p">,</span><span class="mi">641</span><span class="p">},{</span><span class="mi">17</span><span class="p">,</span><span class="mi">640</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">18</span><span class="p">,</span><span class="mi">643</span><span class="p">},{</span><span class="mi">19</span><span class="p">,</span><span class="mi">642</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">20</span><span class="p">,</span><span class="mi">645</span><span class="p">},{</span><span class="mi">21</span><span class="p">,</span><span class="mi">644</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">22</span><span class="p">,</span><span class="mi">647</span><span class="p">},{</span><span class="mi">23</span><span class="p">,</span><span class="mi">646</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">24</span><span class="p">,</span><span class="mi">649</span><span class="p">},{</span><span class="mi">25</span><span class="p">,</span><span class="mi">648</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">26</span><span class="p">,</span><span class="mi">651</span><span class="p">},{</span><span class="mi">27</span><span class="p">,</span><span class="mi">650</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">28</span><span class="p">,</span><span class="mi">653</span><span class="p">},{</span><span class="mi">29</span><span class="p">,</span><span class="mi">652</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">30</span><span class="p">,</span><span class="mi">655</span><span class="p">},{</span><span class="mi">31</span><span class="p">,</span><span class="mi">654</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">32</span><span class="p">,</span><span class="mi">689</span><span class="p">},{</span><span class="mi">33</span><span class="p">,</span><span class="mi">688</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">34</span><span class="p">,</span><span class="mi">691</span><span class="p">},{</span><span class="mi">35</span><span class="p">,</span><span class="mi">690</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">36</span><span class="p">,</span><span class="mi">693</span><span class="p">},{</span><span class="mi">37</span><span class="p">,</span><span class="mi">692</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">38</span><span class="p">,</span><span class="mi">695</span><span class="p">},{</span><span class="mi">39</span><span class="p">,</span><span class="mi">694</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">40</span><span class="p">,</span><span class="mi">697</span><span class="p">},{</span><span class="mi">41</span><span class="p">,</span><span class="mi">696</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">42</span><span class="p">,</span><span class="mi">699</span><span class="p">},{</span><span class="mi">43</span><span class="p">,</span><span class="mi">698</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">44</span><span class="p">,</span><span class="mi">701</span><span class="p">},{</span><span class="mi">45</span><span class="p">,</span><span class="mi">700</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">46</span><span class="p">,</span><span class="mi">703</span><span class="p">},{</span><span class="mi">47</span><span class="p">,</span><span class="mi">702</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">48</span><span class="p">,</span><span class="mi">673</span><span class="p">},{</span><span class="mi">49</span><span class="p">,</span><span class="mi">672</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">50</span><span class="p">,</span><span class="mi">675</span><span class="p">},{</span><span class="mi">51</span><span class="p">,...}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">52</span><span class="p">,...},{...}],</span>
</span><span class='line'> <span class="p">[{...}|...],</span>
</span><span class='line'> <span class="p">[...]|...]</span>
</span><span class='line'><span class="mi">27</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="n">flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="o">==</span> <span class="nn">lists</span><span class="p">:</span><span class="n">sort</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="n">flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">)).</span>
</span><span class='line'><span class="n">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>As usual the full code is in the <a href="http://github.com/jamii/erl-telehash">repo</a>.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2011-03-23T06:16:00+00:00" pubdate data-updated="true">23 Mar 2011</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/erlang/'>erlang</a>, <a class='category' href='/blog/categories/telehash/'>telehash</a>


</div>
	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner"><div class="ps">I am often available for consulting work. Check out my <a href="/about.html">resume</a>.</div>
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'scattered-thoughts';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://scattered-thoughts.net/blog/2011/03/23/telehash-bittrees/';
        var disqus_url = 'http://scattered-thoughts.net/blog/2011/03/23/telehash-bittrees/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-18515092-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>