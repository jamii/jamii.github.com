
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Telehash: bit_trees - Scattered Thoughts</title>
  <meta name="author" content="Jamie Brandon">

  
  <meta name="description" content="The next step in building a switch is managing a routing table. Actually, the next step is handling sessions via ring/line but I&rsquo;m still &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://scattered-thoughts.net/blog/2011/03/23/telehash-bittrees">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Scattered Thoughts" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-18515092-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/jamii" rel="subscribe-github" title="@jamii on GitHub" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
<ul class="subscribe">
  <li><a href="https://twitter.com/jamiiecb" rel="subscribe-twitter" title="@jamiiecb on Twitter" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewBox="0 0 512 512"><path class="social" d="M0.001,334.932c33.327,30.816,118.891,59.981,188.517-8.271c-12.52,1.955-22.972-0.416-30.913-8.269
  c-7.531-7.465-7.945-15.182-3.914-22.202c3.275-5.725,10.184-9.741,16.977-13.934c-12.323,2.285-22.829,1.095-32.218-3.706
  c-12.604-6.444-24.863-13.228-28.3-27.207c7.71-8.112,16.28-15.359,34.831-12.627c-17.45-5.83-33.087-13.429-44.41-24.815
  c-11.028-11.091-12.163-18.302-13.932-26.996c9.632-3.567,19.688-5.421,30.478-4.353c-24.397-12.476-34.757-29.63-40.487-48.325
  c-1.731-5.652-2.044-11.03-1.31-16.545c98.826,37.305,145.11,64.109,170.662,89.251c11.496-30.589,38.3-99.868,78.371-123.646
  c0.191,3.77-1.309,7.837-4.357,12.189c11.863-6.609,21.125-17.188,37.445-16.98c-1.879,7.723-7.279,13.904-17.85,17.854
  c10.662-4.084,21.463-7.545,32.65-9.578c10.375-1.881,10.229,6.304,4.355,10.444c-11.916,8.412-24.578,9.456-37.006,13.498
  c38.105,0.949,69.266,18.994,93.604,58.343c8.088,13.074,13.52,26.149,14.807,40.487c16.254,4.563,32.426,5.494,48.76,2.61
  c4.475-0.796,8.645-1.63,12.627-3.482c-6.354,9.529-13.686,17.356-23.947,20.899c-9.811,3.387-19.637,6.688-30.473,6.968
  c17.641,6.675,37.082,7.045,57.033,5.659c-24.402,23.486-43.08,22.922-61.824,22.642c-8.221,34.703-25.025,69.315-60.52,101.005
  c-46.559,41.569-96.678,61.397-148.457,65.742c-48.552,4.07-95.488,3.512-146.726-20.464
  C56.486,393.349,24.648,368.884,0.001,334.932L0.001,334.932z"/></svg></a></li>
</ul>
  
  
  
  
  
<ul class="main-navigation">
  <li><a href="/"><h2>scattered thoughts</h2></a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Telehash: bit_trees</h1>
      
    
  </header>


<div class="entry-content"><p>The next step in building a switch is managing a routing table. Actually, the next step is handling sessions via ring/line but I&rsquo;m still mulling over the protocol so we&rsquo;ll skip to the routing table.</p>

<!--more-->


<p>I&rsquo;ll add the usual &lsquo;I don&rsquo;t understand Kademlia and I didn&rsquo;t test my code&rsquo; disclaimer in here.</p>

<p>Routing in the Kademlia paper is described using what can best be called the &lsquo;mash everything together and be vague about the details&rsquo; pattern. I want my switch to be a bit cleaner than that so I&rsquo;ve split it into three modules. The first of these is the bit_tree.</p>

<p>The bit_tree is a suffix tree which maps ends (lists of bits) to buckets. The bit_tree neither knows nor cares what a bucket is and for now you don&rsquo;t either. The utility of this tree comes down to one important property: the floor of the log (base 2) of the XOR distance between two ends is the height of the smallest sub-tree which contains both of them. Got that? For example, if log(distance(EndA,EndB)) == 7.234&hellip; then the height of the smallest sub-tree containing both EndA and EndB is 7 nodes. This makes it easy to locate the nearest known nodes to a specified end, something we are supposed to do in response to a <em>.see</em> command.</p>

<p>So here is a bog-standard binary suffix tree:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% a bit_tree is either a leaf or a branch</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">leaf</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">size</span><span class="p">,</span> <span class="c">% size of bucket</span>
</span><span class='line'>    <span class="n">bucket</span> <span class="c">% some opaque bucket of stuff</span>
</span><span class='line'>   <span class="p">}).</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">branch</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">size</span><span class="p">,</span> <span class="c">% size(childF) + size(childT)</span>
</span><span class='line'>    <span class="n">childF</span><span class="p">,</span> <span class="c">% tree containing nodes whose next bit is false</span>
</span><span class='line'>    <span class="n">childT</span> <span class="c">% % tree containing nodes whose next bit is true</span>
</span><span class='line'>   <span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>When adding nodes to a bucket we need to keep track of certain numbers which will be used by the router to decide when to split buckets. Some of these are quite complicated so to make this easier we will work with a zipper-like structure instead of using <em>leaf</em> and <em>branch</em> directly. If you know what a zipper is the code in this post will make sense. If you don&rsquo;t know what a zipper is, go find out. When you come back the code in this post will make sense.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% zipper-esque structure marking a position in a bit_tree</span>
</span><span class='line'><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">finger</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sizer</span><span class="p">,</span> <span class="c">% a size function for buckets</span>
</span><span class='line'>    <span class="n">tree</span><span class="p">,</span> <span class="c">% current sub-tree</span>
</span><span class='line'>    <span class="n">self</span><span class="p">,</span> <span class="c">% the path *to* self (the nodes own end). either {down, Down_bits} or {up, Up_bits, Down_bits, Gap}</span>
</span><span class='line'>      <span class="c">% where Gap is the size of the largest tree containing self but not touching this finger</span>
</span><span class='line'>    <span class="n">depth</span><span class="p">,</span> <span class="c">% the number of bits away from the root tree</span>
</span><span class='line'>    <span class="n">zipper</span> <span class="c">% a list of {Bit, Tree} pairs marking branches NOT taken</span>
</span><span class='line'>   <span class="p">}).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The finger keeps track of where the nodes own end is located in the tree in order to calculate something I have termed the gap &ndash; the size of the largest sub-tree containing the nodes own end but not touching the finger.</p>

<p>The empty bit_tree is easy to define:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">empty</span><span class="p">(</span><span class="nv">Self</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Sizer</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>       <span class="n">sizer</span> <span class="o">=</span> <span class="nv">Sizer</span><span class="p">,</span>
</span><span class='line'>       <span class="n">tree</span> <span class="o">=</span> <span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Sizer</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span> <span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">},</span>
</span><span class='line'>       <span class="n">self</span> <span class="o">=</span> <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="nv">Self</span><span class="p">},</span>
</span><span class='line'>       <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>       <span class="n">zipper</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>      <span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Moving around within the tree is a little more complicated but if you already went away and read about zippers it should feel familiar. Most of the work is in keeping track of the gap.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">extend</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nl">#finger</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="nl">#leaf</span><span class="p">{}}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c">% must always end on a leaf</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Finger</span><span class="p">};</span>
</span><span class='line'><span class="nf">extend</span><span class="p">([</span><span class="nv">Next</span> <span class="p">|</span> <span class="nv">Bits</span><span class="p">],</span>
</span><span class='line'>       <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>   <span class="n">tree</span> <span class="o">=</span> <span class="nl">#branch</span><span class="p">{</span><span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">},</span>
</span><span class='line'>   <span class="n">self</span> <span class="o">=</span> <span class="nv">Self</span><span class="p">,</span>
</span><span class='line'>   <span class="n">depth</span> <span class="o">=</span> <span class="nv">Depth</span><span class="p">,</span>
</span><span class='line'>   <span class="n">zipper</span> <span class="o">=</span> <span class="nv">Zipper</span>
</span><span class='line'>  <span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Branch_taken</span><span class="p">,</span> <span class="nv">Branch_missed</span><span class="p">}</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Next</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">false</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">ChildF</span><span class="p">,</span> <span class="nv">ChildT</span><span class="p">};</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">ChildT</span><span class="p">,</span> <span class="nv">ChildF</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Self2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Self</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="nv">Up</span><span class="p">,</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% already stepped out of gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[</span><span class="ow">not</span><span class="p">(</span><span class="nv">Next</span><span class="p">)|</span><span class="nv">Up</span><span class="p">],</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Down</span><span class="p">]}</span> <span class="k">when</span> <span class="nv">Bit</span> <span class="o">==</span> <span class="nv">Next</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% still in the gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="nv">Down</span><span class="p">};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Down</span><span class="p">]}</span> <span class="k">when</span> <span class="nv">Bit</span> <span class="o">/=</span> <span class="nv">Next</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% leaving gap, check its size</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[</span><span class="ow">not</span><span class="p">(</span><span class="nv">Next</span><span class="p">)],</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Down</span><span class="p">],</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">Branch_missed</span><span class="p">)}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Depth2</span> <span class="o">=</span> <span class="nv">Depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Zipper2</span> <span class="o">=</span> <span class="p">[{</span><span class="ow">not</span><span class="p">(</span><span class="nv">Next</span><span class="p">),</span> <span class="nv">Branch_missed</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Zipper</span><span class="p">],</span>
</span><span class='line'>    <span class="nv">Finger2</span> <span class="o">=</span> <span class="nv">Finger</span><span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>      <span class="n">tree</span> <span class="o">=</span> <span class="nv">Branch_taken</span><span class="p">,</span>
</span><span class='line'>      <span class="n">self</span> <span class="o">=</span> <span class="nv">Self2</span><span class="p">,</span>
</span><span class='line'>      <span class="n">depth</span> <span class="o">=</span> <span class="nv">Depth2</span><span class="p">,</span>
</span><span class='line'>      <span class="n">zipper</span> <span class="o">=</span> <span class="nv">Zipper2</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>    <span class="n">extend</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Finger2</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">retract</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Finger</span><span class="p">;</span>
</span><span class='line'><span class="nf">retract</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span>
</span><span class='line'>  <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>    <span class="n">tree</span> <span class="o">=</span> <span class="nv">Tree</span><span class="p">,</span>
</span><span class='line'>    <span class="n">self</span> <span class="o">=</span> <span class="nv">Self</span><span class="p">,</span>
</span><span class='line'>    <span class="n">depth</span> <span class="o">=</span> <span class="nv">Depth</span><span class="p">,</span>
</span><span class='line'>    <span class="n">zipper</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Last</span><span class="p">,</span><span class="nv">Branch</span><span class="p">}|</span><span class="nv">Zipper</span><span class="p">]</span>
</span><span class='line'>   <span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="k">when</span> <span class="nv">N</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Size</span> <span class="o">=</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">Tree</span><span class="p">)</span> <span class="o">+</span> <span class="n">tree_size</span><span class="p">(</span><span class="nv">Branch</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">Tree2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Last</span> <span class="k">of</span>
</span><span class='line'>      <span class="n">false</span> <span class="o">-&gt;</span> <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">childF</span><span class="o">=</span><span class="nv">Branch</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">Tree</span><span class="p">};</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">-&gt;</span> <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Size</span><span class="p">,</span> <span class="n">childF</span><span class="o">=</span><span class="nv">Tree</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">Branch</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Self2</span> <span class="o">=</span>
</span><span class='line'>  <span class="k">case</span> <span class="nv">Self</span> <span class="k">of</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="nv">Down</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% already in gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Last</span><span class="p">|</span><span class="nv">Down</span><span class="p">]};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[],</span> <span class="nv">Down</span><span class="p">,</span> <span class="p">_</span><span class="nv">Gap</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% just entered gap</span>
</span><span class='line'>      <span class="p">{</span><span class="n">down</span><span class="p">,</span> <span class="p">[</span><span class="nv">Last</span><span class="p">|</span><span class="nv">Down</span><span class="p">]};</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Up</span><span class="p">],</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">}</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c">% still outside gap</span>
</span><span class='line'>      <span class="n">true</span> <span class="o">=</span> <span class="p">(</span><span class="nv">Bit</span><span class="o">==</span><span class="nv">Last</span><span class="p">),</span> <span class="c">% assert</span>
</span><span class='line'>      <span class="p">{</span><span class="n">up</span><span class="p">,</span> <span class="nv">Up</span><span class="p">,</span> <span class="nv">Down</span><span class="p">,</span> <span class="nv">Gap</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Depth2</span> <span class="o">=</span> <span class="nv">Depth</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">Finger2</span> <span class="o">=</span>
</span><span class='line'>  <span class="nv">Finger</span><span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>    <span class="n">tree</span><span class="o">=</span><span class="nv">Tree2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">self</span><span class="o">=</span><span class="nv">Self2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">depth</span><span class="o">=</span><span class="nv">Depth2</span><span class="p">,</span>
</span><span class='line'>    <span class="n">zipper</span><span class="o">=</span><span class="nv">Zipper</span>
</span><span class='line'>   <span class="p">},</span>
</span><span class='line'>    <span class="n">retract</span><span class="p">(</span><span class="nv">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">Finger2</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <em>extend</em> and <em>retract</em> functions are only used internally. We export a much simpler function, <em>move_to</em>, which moves the finger to point at the bucket corresponding to the specified end.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">move_to</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="nl">#finger</span><span class="p">{</span><span class="n">depth</span><span class="o">=</span><span class="nv">Depth</span><span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="k">when</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Bits</span><span class="p">)</span> <span class="o">==</span> <span class="o">?</span><span class="nv">END_BITS</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c">% !!! naive version</span>
</span><span class='line'>    <span class="n">extend</span><span class="p">(</span><span class="nv">Bits</span><span class="p">,</span> <span class="n">retract</span><span class="p">(</span><span class="nv">Depth</span><span class="p">,</span> <span class="nv">Finger</span><span class="p">)).</span>
</span></code></pre></td></tr></table></div></figure>


<p>We could make this more efficient by only retracting until the finger meets <em>Bits</em> partway up. For now I don&rsquo;t expect performance of the bit_tree to be an issue.</p>

<p>Now that we can find buckets we can modify them. Deciding when to split buckets is not the concern of the bit_tree so we delegate it to the caller.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="nf">update</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span>
</span><span class='line'>       <span class="nl">#finger</span><span class="p">{</span>
</span><span class='line'>   <span class="n">sizer</span><span class="o">=</span><span class="nv">Sizer</span><span class="p">,</span>
</span><span class='line'>   <span class="n">tree</span><span class="o">=</span><span class="nl">#leaf</span><span class="p">{</span><span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">}</span>
</span><span class='line'>  <span class="p">}</span><span class="o">=</span><span class="nv">Finger</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Tree</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="nv">Fun</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)),</span>
</span><span class='line'>    <span class="nv">Finger</span><span class="nl">#finger</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="nv">Tree</span><span class="p">}.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nl">#leaf</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="nv">Sizer</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">),</span> <span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">};</span>
</span><span class='line'><span class="nf">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="nv">SplitF</span><span class="p">,</span> <span class="nv">SplitT</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">ChildF</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="nv">SplitF</span><span class="p">),</span>
</span><span class='line'>    <span class="nv">ChildT</span> <span class="o">=</span> <span class="n">bucket_update_to_tree</span><span class="p">(</span><span class="nv">Sizer</span><span class="p">,</span> <span class="nv">SplitT</span><span class="p">),</span>
</span><span class='line'>    <span class="nl">#branch</span><span class="p">{</span><span class="nb">size</span><span class="o">=</span><span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">)</span><span class="o">+</span><span class="n">tree_size</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">),</span> <span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">}.</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to handle <em>.see</em> commands the <em>iter</em> function is used to return buckets in order of distance from the specified end. Here we are making use of the aforementioned nice properties of the bit_tree in order to efficiently return the buckets in order.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to (current position ++ Suffix)</span>
</span><span class='line'><span class="nf">iter</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nl">#finger</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="nv">Tree</span><span class="p">,</span> <span class="n">zipper</span><span class="o">=</span><span class="nv">Zipper</span><span class="p">})</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">Tree</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="n">iter_zipper</span><span class="p">(</span><span class="nv">Zipper</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">)).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to (current position ++ Suffix)</span>
</span><span class='line'><span class="nf">iter_zipper</span><span class="p">([],</span> <span class="p">_</span><span class="nv">Suffix</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">done</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="nf">iter_zipper</span><span class="p">([{</span><span class="nv">Bit</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Zipper</span><span class="p">],</span> <span class="nv">Suffix</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">Tree</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="n">iter_zipper</span><span class="p">(</span><span class="nv">Zipper</span><span class="p">,</span> <span class="p">[</span><span class="ow">not</span><span class="p">(</span><span class="nv">Bit</span><span class="p">)|</span><span class="nv">Suffix</span><span class="p">])).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% iterate through buckets in ascending order of xor distance to Bits, then hand over to Iter</span>
</span><span class='line'><span class="nf">iter_buckets</span><span class="p">(</span><span class="nl">#leaf</span><span class="p">{</span><span class="n">bucket</span><span class="o">=</span><span class="nv">Bucket</span><span class="p">},</span> <span class="p">_</span><span class="nv">Bits</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="nv">Bucket</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">;</span>
</span><span class='line'><span class="nf">iter_buckets</span><span class="p">(</span><span class="nl">#branch</span><span class="p">{</span><span class="n">childF</span><span class="o">=</span><span class="nv">ChildF</span><span class="p">,</span> <span class="n">childT</span><span class="o">=</span><span class="nv">ChildT</span><span class="p">},</span> <span class="p">[</span><span class="nv">Bit</span><span class="p">|</span><span class="nv">Bits</span><span class="p">],</span> <span class="nv">Iter</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">case</span> <span class="nv">Bit</span> <span class="k">of</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">));</span>
</span><span class='line'>  <span class="n">false</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildF</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="n">iter_buckets</span><span class="p">(</span><span class="nv">ChildT</span><span class="p">,</span> <span class="nv">Bits</span><span class="p">,</span> <span class="nv">Iter</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will typically be called like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="p">{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="n">move_to</span><span class="p">(</span><span class="nn">util</span><span class="p">:</span><span class="n">to_bits</span><span class="p">(</span><span class="nv">End</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">),</span>
</span><span class='line'><span class="nn">bit_tree</span><span class="p">:</span><span class="n">iter</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Splitting the routing table into separate structures like this makes for easier testing. The bit_tree can be tested independently using really simple buckets where the elements are just integers and the buckets split when they reach more than three elements.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="c">% simple buckets used for testing bit_tree</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">test_bucket</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;conf.hrl&quot;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">bits</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">add</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">split</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">move_to</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">add_to_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">make_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">distance</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">move_list_from</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">list_from</span><span class="o">/</span><span class="mi">3</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">MAX_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span>
</span><span class='line'><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">BITS</span><span class="p">,</span> <span class="o">?</span><span class="nv">END_BITS</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">util</span><span class="p">:</span><span class="nf">to_bits</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">Int</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">split</span><span class="p">([{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">}</span> <span class="p">|</span> <span class="nv">Bucket</span><span class="p">]).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">split</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="k">if</span>
</span><span class='line'>  <span class="nb">length</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">?</span><span class="nv">MAX_SIZE</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="nv">BucketF</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Int2</span><span class="p">}</span> <span class="p">||</span> <span class="p">{[</span><span class="n">false</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">],</span> <span class="nv">Int2</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">],</span>
</span><span class='line'>      <span class="nv">BucketT</span> <span class="o">=</span> <span class="p">[{</span><span class="nv">Suffix2</span><span class="p">,</span> <span class="nv">Int2</span><span class="p">}</span> <span class="p">||</span> <span class="p">{[</span><span class="n">true</span> <span class="p">|</span> <span class="nv">Suffix2</span><span class="p">],</span> <span class="nv">Int2</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">],</span>
</span><span class='line'>      <span class="p">{</span><span class="n">split</span><span class="p">,</span> <span class="n">split</span><span class="p">(</span><span class="nv">BucketF</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="nv">BucketT</span><span class="p">)};</span>
</span><span class='line'>  <span class="n">true</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">}</span>
</span><span class='line'>    <span class="k">end</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nf">move_to</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">bit_tree</span><span class="p">:</span><span class="nf">move_to</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">add_to_tree</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">}</span> <span class="o">=</span> <span class="n">move_to</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">bit_tree</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span><span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Int</span><span class="p">,</span> <span class="nv">Bucket</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">make_tree</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Ints</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">Tree</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="nf">empty</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="p">[],</span> <span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p">(</span><span class="k">fun</span> <span class="n">add_to_tree</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">,</span> <span class="nv">Ints</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">distance</span><span class="p">(</span><span class="nv">IntA</span><span class="p">,</span> <span class="nv">IntB</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nn">util</span><span class="p">:</span><span class="nf">distance</span><span class="p">({</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">IntA</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">},</span> <span class="p">{</span><span class="n">&#39;end&#39;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="nv">IntB</span><span class="p">:</span><span class="o">?</span><span class="nv">BITS</span><span class="o">&gt;&gt;</span><span class="p">}).</span>
</span><span class='line'>
</span><span class='line'><span class="c">% output *should* be in ascending order</span>
</span><span class='line'><span class="nf">move_list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">}</span> <span class="o">=</span> <span class="nn">bit_tree</span><span class="p">:</span><span class="nf">move_to</span><span class="p">(</span><span class="n">bits</span><span class="p">(</span><span class="nv">Int</span><span class="p">),</span> <span class="nv">Tree</span><span class="p">),</span>
</span><span class='line'>    <span class="n">list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree2</span><span class="p">).</span>
</span><span class='line'>
</span><span class='line'><span class="nf">list_from</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">List</span> <span class="o">=</span> <span class="nn">util</span><span class="p">:</span><span class="nf">iter_to_list</span><span class="p">(</span><span class="nn">bit_tree</span><span class="p">:</span><span class="nf">iter</span><span class="p">(</span><span class="nv">Suffix</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">)),</span>
</span><span class='line'>    <span class="nn">lists</span><span class="p">:</span><span class="nf">map</span><span class="p">(</span>
</span><span class='line'>      <span class="k">fun</span> <span class="p">(</span><span class="nv">Bucket</span><span class="p">)</span> <span class="o">-&gt;</span>
</span><span class='line'>        <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">([{</span><span class="n">distance</span><span class="p">(</span><span class="nv">Int</span><span class="p">,</span> <span class="nv">Elem</span><span class="p">),</span> <span class="nv">Elem</span><span class="p">}</span> <span class="p">||</span> <span class="p">{_,</span><span class="nv">Elem</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Bucket</span><span class="p">])</span>
</span><span class='line'>      <span class="k">end</span><span class="p">,</span>
</span><span class='line'>      <span class="nv">List</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can play around with the test buckets a bit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='erlang'><span class='line'><span class="mi">25</span><span class="o">&gt;</span> <span class="nv">Tree</span> <span class="o">=</span> <span class="nn">test_bucket</span><span class="p">:</span><span class="nf">make_tree</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">)).</span>
</span><span class='line'><span class="p">{</span><span class="n">finger</span><span class="p">,</span><span class="err">#</span><span class="nv">Fun</span><span class="o">&lt;</span><span class="n">test_bucket</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">121651971</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">1</span><span class="p">,[{[</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">],</span><span class="mi">1000</span><span class="p">}]},</span>
</span><span class='line'>        <span class="p">{</span><span class="n">up</span><span class="p">,[</span><span class="n">false</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">false</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span>
</span><span class='line'>             <span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span>
</span><span class='line'>             <span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">|...],</span>
</span><span class='line'>            <span class="p">[</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span>
</span><span class='line'>             <span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">,</span><span class="n">true</span><span class="p">|...],</span>
</span><span class='line'>            <span class="mi">0</span><span class="p">},</span>
</span><span class='line'>        <span class="mi">157</span><span class="p">,</span>
</span><span class='line'>        <span class="p">[{</span><span class="n">false</span><span class="p">,{</span><span class="n">branch</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
</span><span class='line'>                        <span class="p">{</span><span class="n">branch</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">993</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">992</span><span class="p">}]},</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">995</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">994</span><span class="p">}]}},</span>
</span><span class='line'>                        <span class="p">{</span><span class="n">branch</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">997</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">996</span><span class="p">}]},</span>
</span><span class='line'>                                <span class="p">{</span><span class="n">leaf</span><span class="p">,</span><span class="mi">2</span><span class="p">,[{[</span><span class="n">true</span><span class="p">],</span><span class="mi">999</span><span class="p">},{[</span><span class="n">false</span><span class="p">],</span><span class="mi">998</span><span class="p">}]}}}},</span>
</span><span class='line'>         <span class="p">{...}|...]}</span>
</span><span class='line'><span class="mi">26</span><span class="o">&gt;</span> <span class="nv">List</span> <span class="o">=</span> <span class="nn">test_bucket</span><span class="p">:</span><span class="nf">move_list_from</span><span class="p">(</span><span class="mi">657</span><span class="p">,</span> <span class="nv">Tree</span><span class="p">).</span>
</span><span class='line'><span class="p">[[{</span><span class="mi">0</span><span class="p">,</span><span class="mi">657</span><span class="p">},{</span><span class="mi">1</span><span class="p">,</span><span class="mi">656</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">2</span><span class="p">,</span><span class="mi">659</span><span class="p">},{</span><span class="mi">3</span><span class="p">,</span><span class="mi">658</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">4</span><span class="p">,</span><span class="mi">661</span><span class="p">},{</span><span class="mi">5</span><span class="p">,</span><span class="mi">660</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">6</span><span class="p">,</span><span class="mi">663</span><span class="p">},{</span><span class="mi">7</span><span class="p">,</span><span class="mi">662</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">8</span><span class="p">,</span><span class="mi">665</span><span class="p">},{</span><span class="mi">9</span><span class="p">,</span><span class="mi">664</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">10</span><span class="p">,</span><span class="mi">667</span><span class="p">},{</span><span class="mi">11</span><span class="p">,</span><span class="mi">666</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">12</span><span class="p">,</span><span class="mi">669</span><span class="p">},{</span><span class="mi">13</span><span class="p">,</span><span class="mi">668</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">14</span><span class="p">,</span><span class="mi">671</span><span class="p">},{</span><span class="mi">15</span><span class="p">,</span><span class="mi">670</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">16</span><span class="p">,</span><span class="mi">641</span><span class="p">},{</span><span class="mi">17</span><span class="p">,</span><span class="mi">640</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">18</span><span class="p">,</span><span class="mi">643</span><span class="p">},{</span><span class="mi">19</span><span class="p">,</span><span class="mi">642</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">20</span><span class="p">,</span><span class="mi">645</span><span class="p">},{</span><span class="mi">21</span><span class="p">,</span><span class="mi">644</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">22</span><span class="p">,</span><span class="mi">647</span><span class="p">},{</span><span class="mi">23</span><span class="p">,</span><span class="mi">646</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">24</span><span class="p">,</span><span class="mi">649</span><span class="p">},{</span><span class="mi">25</span><span class="p">,</span><span class="mi">648</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">26</span><span class="p">,</span><span class="mi">651</span><span class="p">},{</span><span class="mi">27</span><span class="p">,</span><span class="mi">650</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">28</span><span class="p">,</span><span class="mi">653</span><span class="p">},{</span><span class="mi">29</span><span class="p">,</span><span class="mi">652</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">30</span><span class="p">,</span><span class="mi">655</span><span class="p">},{</span><span class="mi">31</span><span class="p">,</span><span class="mi">654</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">32</span><span class="p">,</span><span class="mi">689</span><span class="p">},{</span><span class="mi">33</span><span class="p">,</span><span class="mi">688</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">34</span><span class="p">,</span><span class="mi">691</span><span class="p">},{</span><span class="mi">35</span><span class="p">,</span><span class="mi">690</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">36</span><span class="p">,</span><span class="mi">693</span><span class="p">},{</span><span class="mi">37</span><span class="p">,</span><span class="mi">692</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">38</span><span class="p">,</span><span class="mi">695</span><span class="p">},{</span><span class="mi">39</span><span class="p">,</span><span class="mi">694</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">40</span><span class="p">,</span><span class="mi">697</span><span class="p">},{</span><span class="mi">41</span><span class="p">,</span><span class="mi">696</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">42</span><span class="p">,</span><span class="mi">699</span><span class="p">},{</span><span class="mi">43</span><span class="p">,</span><span class="mi">698</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">44</span><span class="p">,</span><span class="mi">701</span><span class="p">},{</span><span class="mi">45</span><span class="p">,</span><span class="mi">700</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">46</span><span class="p">,</span><span class="mi">703</span><span class="p">},{</span><span class="mi">47</span><span class="p">,</span><span class="mi">702</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">48</span><span class="p">,</span><span class="mi">673</span><span class="p">},{</span><span class="mi">49</span><span class="p">,</span><span class="mi">672</span><span class="p">}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">50</span><span class="p">,</span><span class="mi">675</span><span class="p">},{</span><span class="mi">51</span><span class="p">,...}],</span>
</span><span class='line'> <span class="p">[{</span><span class="mi">52</span><span class="p">,...},{...}],</span>
</span><span class='line'> <span class="p">[{...}|...],</span>
</span><span class='line'> <span class="p">[...]|...]</span>
</span><span class='line'><span class="mi">27</span><span class="o">&gt;</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">)</span> <span class="o">==</span> <span class="nn">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nv">List</span><span class="p">)).</span>
</span><span class='line'><span class="n">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>As usual the full code is in the <a href="http://github.com/jamii/erl-telehash">repo</a>.</p>
</div>


  <footer>
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2011/03/21/telehash-dialing/" title="Previous Post: Telehash: dialing">&laquo; Telehash: dialing</a>
      
      
        <a class="basic-alignment right" href="/blog/2011/03/24/telehash-bittrees-revisited/" title="Next Post: Telehash: bit_trees revisited">Telehash: bit_trees revisited &raquo;</a>
      
    </p>
  </footer>
</article>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Jamie Brandon
</p>

</footer>
  











</body>
</html>
